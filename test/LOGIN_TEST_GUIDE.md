# 登录功能测试指南

## 测试环境要求

1. 微信开发者工具（最新版）
2. 真机调试（getPhoneNumber 需要在真机上测试）

---

## 测试步骤

### 第一步：在微信开发者工具中预览

1. 打开微信开发者工具
2. 导入项目 `D:\bread-bakery-miniprogram`
3. 点击「预览」生成二维码
4. 使用微信扫描二维码

### 第二步：测试登录页面

1. 在小程序中进入「我的」页面
2. 点击「登录/注册」按钮
3. 进入登录页面

### 第三步：测试手机号一键登录

#### 场景 1：新用户首次登录

1. 勾选「我已阅读并同意用户协议和隐私政策」
2. 点击「📱 手机号一键登录」按钮
3. 微信弹出授权窗口，点击「允许」
4. **预期结果**：
   - 显示「注册成功」
   - 页面显示用户头像和昵称
   - 自动返回上一页
   - 数据库新增一条用户记录（以手机号为标识）

#### 场景 2：已有用户登录

1. 使用已注册的手机号重复上述步骤
2. **预期结果**：
   - 显示「登录成功」
   - 显示之前保存的用户信息
   - 积分、等级等数据保持一致

#### 场景 3：拒绝授权

1. 点击「手机号一键登录」
2. 在微信授权窗口点击「拒绝」
3. **预期结果**：
   - 显示「需要授权手机号才能登录」
   - 停留在登录页面

### 第四步：测试获取用户信息

1. 在登录页面点击「选择微信头像」
2. 选择头像后，点击「获取微信昵称」
3. **预期结果**：
   - 头像和昵称显示在页面上
   - 登录时这些信息会同步保存

### 第五步：测试传统登录方式

1. 点击「使用传统方式登录」
2. **预期结果**：
   - 使用 OpenID 方式登录
   - 可以正常登录但没有手机号

---

## 数据库验证

登录成功后，在云开发控制台验证：

1. 打开「云开发」→「数据库」
2. 进入 `users` 集合
3. 查看新创建的记录：
   - `phone` 字段应为真实手机号
   - `openid` 字段应为当前用户 OpenID
   - `nickName` 和 `avatarUrl` 应已保存
   - `token` 和 `tokenExpireTime` 应已设置

---

## 常见问题

### 1. 提示 "getPhoneNumber:fail no permission"

**原因**：小程序没有申请手机号获取权限

**解决**：
- 登录微信公众平台
- 进入「开发」→「开发管理」→「接口设置」
- 申请「获取手机号」权限

### 2. 提示 "cloud.callFunction is not a function"

**原因**：云开发未初始化

**解决**：检查 `app.js` 中是否正确调用 `wx.cloud.init()`

### 3. 登录成功但用户信息未保存

**原因**：可能是 store 更新问题

**解决**：检查控制台是否有错误日志，确认 `app.store` 是否初始化成功

### 4. 真机调试正常，模拟器不行

**原因**：`getPhoneNumber` 必须在真机上运行

**解决**：这是正常现象，模拟器不支持获取手机号

---

## 测试检查清单

- [ ] 页面正常显示
- [ ] 协议勾选框可正常切换
- [ ] 手机号登录按钮可点击
- [ ] 授权窗口正常弹出
- [ ] 登录成功后显示正确提示
- [ ] 登录成功后自动返回
- [ ] 数据库有正确的用户记录
- [ ] 重新进入小程序保持登录状态
- [ ] 退出登录后清除所有用户信息

---

## 调试技巧

### 查看日志

在代码关键位置已添加 `console.log`，可在微信开发者工具控制台查看：

```
[登录] 页面加载
[登录] 手机号登录事件
[登录] 手机号登录结果
[登录] 已同步更新全局 store
```

### 清除登录状态

如需重新测试登录，可在控制台运行：

```javascript
wx.clearStorageSync();
wx.reLaunch({ url: '/pages/login/login' });
```

### 查看本地存储

```javascript
const authInfo = wx.getStorageSync('auth_info');
console.log('登录信息:', authInfo);
```

---

## 联系支持

如有问题，请查看：
- 云函数日志：云开发 → 云函数 → 日志
- 数据库记录：云开发 → 数据库 → users
- 项目文档：`CLAUDE.md`
