<!-- ç¡®è®¤è®¢å•é¡µé¢ -->
<view class="order-confirm-container">
  <!-- æ”¶è´§åœ°å€ -->
  <view class="address-section" bindtap="selectAddress">
    <view class="address-content" wx:if="{{address}}">
      <view class="address-icon">
        <text class="icon">ğŸ“</text>
      </view>
      <view class="address-info">
        <view class="address-header">
          <text class="address-name">{{address.name}}</text>
          <text class="address-phone">{{address.phone}}</text>
        </view>
        <text class="address-detail">{{address.province}}{{address.city}}{{address.district}}{{address.detail}}</text>
      </view>
      <text class="arrow">></text>
    </view>
    <view class="address-empty" wx:else>
      <view class="add-address-btn">
        <text class="plus-icon">+</text>
        <text>æ·»åŠ æ”¶è´§åœ°å€</text>
      </view>
    </view>
    <view class="address-border"></view>
  </view>

  <!-- é…é€æ–¹å¼ -->
  <view class="delivery-section">
    <view class="section-title">é…é€æ–¹å¼</view>
    <view class="delivery-options">
      <view 
        class="delivery-option {{deliveryType === 'delivery' ? 'active' : ''}}" 
        bindtap="selectDeliveryType"
        data-type="delivery"
      >
        <view class="option-icon">ğŸšš</view>
        <view class="option-info">
          <text class="option-name">é…é€åˆ°å®¶</text>
          <text class="option-desc">é¢„è®¡{{deliveryTime}}é€è¾¾</text>
        </view>
        <view class="option-price">Â¥{{deliveryFee}}</view>
        <view class="check-mark" wx:if="{{deliveryType === 'delivery'}}">âœ“</view>
      </view>
      <view 
        class="delivery-option {{deliveryType === 'selfpickup' ? 'active' : ''}}" 
        bindtap="selectDeliveryType"
        data-type="selfpickup"
      >
        <view class="option-icon">ğŸª</view>
        <view class="option-info">
          <text class="option-name">åˆ°åº—è‡ªå–</text>
          <text class="option-desc">{{storeAddress}}</text>
        </view>
        <view class="option-price free">å…è´¹</view>
        <view class="check-mark" wx:if="{{deliveryType === 'selfpickup'}}">âœ“</view>
      </view>
    </view>
  </view>

  <!-- è‡ªå–æ—¶é—´é€‰æ‹©ï¼ˆä»…è‡ªå–æ—¶æ˜¾ç¤ºï¼‰ -->
  <view class="pickup-time-section" wx:if="{{deliveryType === 'selfpickup'}}">
    <view class="section-title">è‡ªå–æ—¶é—´</view>
    <picker mode="multiSelector" range="{{pickupTimeRange}}" bindchange="onPickupTimeChange" bindcolumnchange="onPickupTimeColumnChange">
      <view class="picker-content">
        <text class="picker-value">{{selectedPickupTime || 'è¯·é€‰æ‹©è‡ªå–æ—¶é—´'}}</text>
        <text class="arrow">></text>
      </view>
    </picker>
  </view>

  <!-- å•†å“æ¸…å• -->
  <view class="goods-section">
    <view class="section-title">å•†å“æ¸…å•</view>
    <view class="goods-list">
      <view class="goods-item" wx:for="{{orderItems}}" wx:key="_id">
        <image class="goods-image" src="{{item.imageUrl}}" mode="aspectFill"/>
        <view class="goods-info">
          <text class="goods-name">{{item.name}}</text>
          <text class="goods-spec" wx:if="{{item.spec}}">{{item.spec}}</text>
          <view class="goods-bottom">
            <text class="goods-price">Â¥{{item.price}}</text>
            <text class="goods-quantity">x{{item.quantity}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸ -->
  <view class="coupon-section" bindtap="selectCoupon">
    <view class="section-title">ä¼˜æƒ åˆ¸</view>
    <view class="coupon-content">
      <text class="coupon-value {{selectedCoupon ? 'active' : ''}}">
        {{selectedCoupon ? '-Â¥' + selectedCoupon.amount : 'æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸'}}
      </text>
      <text class="arrow">></text>
    </view>
  </view>

  <!-- è®¢å•å¤‡æ³¨ -->
  <view class="remark-section">
    <view class="section-title">è®¢å•å¤‡æ³¨</view>
    <textarea 
      class="remark-input" 
      placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼Œå¦‚å£å‘³åå¥½ã€é…é€è¦æ±‚ç­‰"
      maxlength="100"
      bindinput="onRemarkInput"
      value="{{remark}}"
    />
    <text class="remark-count">{{remark.length}}/100</text>
  </view>

  <!-- ä»·æ ¼æ˜ç»† -->
  <view class="price-section">
    <view class="price-row">
      <text class="price-label">å•†å“æ€»é¢</text>
      <text class="price-value">Â¥{{goodsTotal}}</text>
    </view>
    <view class="price-row">
      <text class="price-label">é…é€è´¹</text>
      <text class="price-value">{{deliveryFee > 0 ? 'Â¥' + deliveryFee : 'å…è¿è´¹'}}</text>
    </view>
    <view class="price-row" wx:if="{{discountAmount > 0}}">
      <text class="price-label">å•†å“ä¼˜æƒ </text>
      <text class="price-value discount">-Â¥{{discountAmount}}</text>
    </view>
    <view class="price-row" wx:if="{{couponAmount > 0}}">
      <text class="price-label">ä¼˜æƒ åˆ¸</text>
      <text class="price-value discount">-Â¥{{couponAmount}}</text>
    </view>
    <view class="price-divider"></view>
    <view class="price-row total">
      <text class="price-label">å®ä»˜é‡‘é¢</text>
      <text class="price-value total-price">Â¥{{payAmount}}</text>
    </view>
  </view>

  <!-- åº•éƒ¨æäº¤æ  -->
  <view class="submit-bar">
    <view class="submit-info">
      <text class="submit-label">å®ä»˜:</text>
      <text class="submit-price">Â¥{{payAmount}}</text>
    </view>
    <button class="submit-btn {{submitting ? 'submitting' : ''}}" bindtap="submitOrder" disabled="{{submitting}}">
      {{submitting ? 'æäº¤ä¸­...' : 'æäº¤è®¢å•'}}
    </button>
  </view>
</view>

<!-- åœ°å€é€‰æ‹©å¼¹çª— -->
<view class="modal-mask" wx:if="{{showAddressModal}}" bindtap="closeAddressModal"></view>
<view class="address-modal" wx:if="{{showAddressModal}}">
  <view class="modal-header">
    <text>é€‰æ‹©æ”¶è´§åœ°å€</text>
    <text class="close-btn" bindtap="closeAddressModal">Ã—</text>
  </view>
  <scroll-view class="address-list" scroll-y>
    <view 
      class="address-item {{selectedAddressId === item._id ? 'active' : ''}}" 
      wx:for="{{addressList}}" 
      wx:key="_id"
      bindtap="confirmAddress"
      data-index="{{index}}"
    >
      <view class="address-item-info">
        <view class="address-item-header">
          <text class="name">{{item.name}}</text>
          <text class="phone">{{item.phone}}</text>
          <text class="default-tag" wx:if="{{item.isDefault}}">é»˜è®¤</text>
        </view>
        <text class="detail">{{item.province}}{{item.city}}{{item.district}}{{item.detail}}</text>
      </view>
      <view class="select-icon" wx:if="{{selectedAddressId === item._id}}">âœ“</view>
    </view>
  </scroll-view>
  <view class="modal-footer">
    <button class="add-new-btn" bindtap="addNewAddress">+ æ–°å»ºåœ°å€</button>
  </view>
</view>

<!-- ä¼˜æƒ åˆ¸é€‰æ‹©å¼¹çª— -->
<view class="modal-mask" wx:if="{{showCouponModal}}" bindtap="closeCouponModal"></view>
<view class="coupon-modal" wx:if="{{showCouponModal}}">
  <view class="modal-header">
    <text>é€‰æ‹©ä¼˜æƒ åˆ¸</text>
    <text class="close-btn" bindtap="closeCouponModal">Ã—</text>
  </view>
  <scroll-view class="coupon-list" scroll-y>
    <view 
      class="coupon-item {{selectedCouponId === item._id ? 'active' : ''}}" 
      wx:for="{{couponList}}" 
      wx:key="_id"
      bindtap="confirmCoupon"
      data-index="{{index}}"
    >
      <view class="coupon-left">
        <text class="coupon-amount">Â¥{{item.amount}}</text>
        <text class="coupon-condition">æ»¡{{item.minAmount}}å¯ç”¨</text>
      </view>
      <view class="coupon-right">
        <text class="coupon-name">{{item.name}}</text>
        <text class="coupon-time">æœ‰æ•ˆæœŸè‡³{{item.expireTime}}</text>
      </view>
      <view class="select-icon" wx:if="{{selectedCouponId === item._id}}">âœ“</view>
    </view>
    <view class="no-coupon" wx:if="{{couponList.length === 0}}">
      <text>æš‚æ— å¯ç”¨ä¼˜æƒ åˆ¸</text>
    </view>
  </scroll-view>
  <view class="modal-footer">
    <button class="not-use-btn" bindtap="notUseCoupon">ä¸ä½¿ç”¨ä¼˜æƒ åˆ¸</button>
  </view>
</view>
