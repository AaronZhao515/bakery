# 暖心烘焙小程序 - 业务架构图

## 1. 整体系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      小程序客户端                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   主包      │  │   分包      │  │      公共组件       │  │
│  │  (Tab页)    │  │  (功能页)   │  │                     │  │
│  │             │  │             │  │  ┌─────┐ ┌────────┐ │  │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │  │导航栏│ │商品卡片│ │  │
│  │ │  首页   │ │  │ │商品详情 │ │  │  └─────┘ └────────┘ │  │
│  │ ├─────────┤ │  │ ├─────────┤ │  │  ┌─────┐ ┌────────┐ │  │
│  │ │ 预订页  │ │  │ │ 购物车  │ │  │  │加载中│ │ 空状态 │ │  │
│  │ ├─────────┤ │  │ ├─────────┤ │  │  └─────┘ └────────┘ │  │
│  │ │ 订单页  │ │  │ │订单确认 │ │  │  ┌─────┐ ┌────────┐ │  │
│  │ ├─────────┤ │  │ ├─────────┤ │  │  │弹窗  │ │ 提示   │ │  │
│  │ │用户中心 │ │  │ │地址管理 │ │  │  └─────┘ └────────┘ │  │
│  │ └─────────┘ │  │ ├─────────┤ │  └─────────────────────┘  │
│  │             │  │ │优惠券   │ │                           │
│  │             │  │ ├─────────┤ │                           │
│  │             │  │ │管理后台 │ │                           │
│  │             │  │ └─────────┘ │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 调用
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      微信云开发后端                         │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐    │
│  │                    云函数 (Node.js)                  │    │
│  ├──────────┬──────────┬──────────┬─────────────────────┤    │
│  │ product/ │  cart/   │  order/  │      pay/           │    │
│  │ 商品服务 │ 购物车   │ 订单服务 │     支付服务        │    │
│  ├──────────┼──────────┼──────────┼─────────────────────┤    │
│  │  user/   │ address/ │ coupon/  │     admin/          │    │
│  │ 用户服务 │ 地址服务 │ 优惠券   │    管理服务         │    │
│  └──────────┴──────────┴──────────┴─────────────────────┘    │
│                              │                              │
│  ┌───────────────────────────┼───────────────────────────┐   │
│  │                           ▼                           │   │
│  │  ┌─────────────────────────────────────────────────┐  │   │
│  │  │              云数据库 (NoSQL)                    │  │   │
│  │  ├─────────┬─────────┬─────────┬─────────┬─────────┤  │   │
│  │  │products │ orders  │  users  │  cart   │addresses│  │   │
│  │  │ 商品表  │ 订单表  │ 用户表  │ 购物车  │ 地址表  │  │   │
│  │  ├─────────┼─────────┼─────────┼─────────┼─────────┤  │   │
│  │  │coupons  │userCoup │categories        │ banners │  │   │
│  │  │优惠券   │用户券   │   分类表         │ 轮播图  │  │   │
│  │  └─────────┴─────────┴─────────┴─────────┴─────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                              │
│  ┌───────────────────────────▼───────────────────────────┐   │
│  │                   云存储                              │   │
│  │         商品图片 / 用户头像 / 其他资源                │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      外部服务                               │
│         ┌─────────────┐              ┌─────────────┐        │
│         │  微信支付   │              │  微信登录   │        │
│         │  (云调用)   │              │  (免鉴权)   │        │
│         └─────────────┘              └─────────────┘        │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心业务流程

### 2.1 下单支付流程

```
用户操作                    客户端                    云函数                    数据库/外部
   │                          │                         │                         │
   │  1. 浏览商品列表          │                         │                         │
   ├────────────────────────>│                         │                         │
   │                          │  2. getProductList()   │                         │
   │                          ├───────────────────────>│                         │
   │                          │                         │  3. 查询 products       │
   │                          │                         ├────────────────────────>│
   │                          │                         │<────────────────────────┤
   │                          │<───────────────────────┤                         │
   │<─────────────────────────┤                         │                         │
   │                          │                         │                         │
   │  4. 查看商品详情          │                         │                         │
   ├────────────────────────>│                         │                         │
   │                          │  5. getProductDetail() │                         │
   │                          ├───────────────────────>│                         │
   │                          │                         │  6. 查询商品详情        │
   │                          │                         ├────────────────────────>│
   │                          │                         │<────────────────────────┤
   │                          │<───────────────────────┤                         │
   │<─────────────────────────┤                         │                         │
   │                          │                         │                         │
   │  7. 加入购物车            │                         │                         │
   ├────────────────────────>│                         │                         │
   │                          │  8. addToCart()        │                         │
   │                          ├───────────────────────>│                         │
   │                          │                         │  9. 写入/更新 cart      │
   │                          │                         ├────────────────────────>│
   │                          │                         │<────────────────────────┤
   │                          │<───────────────────────┤                         │
   │<─────────────────────────┤                         │                         │
   │                          │                         │                         │
   │  10. 提交订单             │                         │                         │
   ├────────────────────────>│                         │                         │
   │                          │ 11. createOrder()      │                         │
   │                          ├───────────────────────>│                         │
   │                          │                         │ 12. 开始事务            │
   │                          │                         ├────┐                    │
   │                          │                         │    │ 13. 检查库存         │
   │                          │                         │    ├──────────────────> │
   │                          │                         │    │<──────────────────┤
   │                          │                         │    │                    │
   │                          │                         │    │ 14. 库存充足?       │
   │                          │                         │    ├───────┐            │
   │                          │                         │    │ 是   │ 否          │
   │                          │                         │    ▼      ▼            │
   │                          │                         │ 15. 扣减库存  16.回滚   │
   │                          │                         │    │                    │
   │                          │                         │    │ 17. 创建订单        │
   │                          │                         │    ├──────────────────> │
   │                          │                         │    │<──────────────────┤
   │                          │                         │<───┘ 18. 提交事务      │
   │                          │<───────────────────────┤                         │
   │<─────────────────────────┤   返回订单信息          │                         │
   │                          │                         │                         │
   │  19. 调用支付             │                         │                         │
   ├────────────────────────>│                         │                         │
   │                          │ 20. unifiedOrder()     │                         │
   │                          ├───────────────────────>│                         │
   │                          │                         │ 21. 调用微信支付API     │
   │                          │                         ├────────────────────────>│
   │                          │                         │<────────────────────────┤
   │                          │<───────────────────────┤   返回支付参数          │
   │<─────────────────────────┤                         │                         │
   │  22. 调起微信支付         │                         │                         │
   ├────────────────────────>│                         │                         │
   │  23. 用户确认支付          │                         │                         │
   │<────────────────────────>│                         │                         │
   │                          │                         │ 24. 支付回调            │
   │                          │                         │<────────────────────────┤
   │                          │                         │ 25. 更新订单状态        │
   │                          │                         ├────────────────────────>│
```

### 2.2 订单状态流转

```
┌─────────┐    支付超时     ┌─────────┐
│ 待支付  │───────────────>│ 已取消  │
└────┬────┘                └─────────┘
     │ 支付成功
     ▼
┌─────────┐    商家发货     ┌─────────┐    确认收货     ┌─────────┐
│ 待发货  │───────────────>│ 待收货  │───────────────>│ 已完成  │
└────┬────┘                └─────────┘                └─────────┘
     │
     │ 申请退款
     ▼
┌─────────┐    同意退款     ┌─────────┐
│ 退款中  │───────────────>│ 已退款  │
└─────────┘                └─────────┘
```

### 2.3 数据库关系

```
                    ┌──────────────┐
                    │    users     │
                    │    用户表     │
                    └──────┬───────┘
                           │
          ┌────────────────┼────────────────┐
          │                │                │
          ▼                ▼                ▼
   ┌────────────┐   ┌────────────┐   ┌────────────┐
   │    cart    │   │   orders   │   │  addresses │
   │   购物车    │   │   订单表    │   │   地址表    │
   └────────────┘   └─────┬──────┘   └────────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
   ┌────────────┐   ┌────────────┐   ┌────────────┐
   │  products  │   │ userCoupons│   │   pay      │
   │   商品表    │   │  用户优惠券 │   │  支付记录  │
   └─────┬──────┘   └────────────┘   └────────────┘
         │
         ▼
   ┌────────────┐
   │ categories │
   │   分类表    │
   └────────────┘

用户优惠券关系:
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   coupons   │────────>│ userCoupons  │<────────│    users    │
│   优惠券表   │  1:N    │  用户优惠券   │   N:1   │    用户表    │
└─────────────┘         └──────────────┘         └─────────────┘
                               │
                               ▼
                        ┌─────────────┐
                        │    orders   │
                        │    订单表    │
                        └─────────────┘
```

## 3. 关键技术设计

### 3.1 防超卖设计
```javascript
// 使用数据库事务保证原子性
const transaction = await db.startTransaction()
try {
  // 1. 查询库存（带锁）
  const product = await transaction.collection('products').doc(id).get()

  // 2. 检查库存
  if (product.data.stock < quantity) {
    await transaction.rollback()
    return { code: -1, message: '库存不足' }
  }

  // 3. 扣减库存
  await transaction.collection('products').doc(id).update({
    data: { stock: _.inc(-quantity) }
  })

  // 4. 创建订单
  await transaction.collection('orders').add({ data: orderData })

  await transaction.commit()
} catch (err) {
  await transaction.rollback()
}
```

### 3.2 状态管理架构
```javascript
// 全局 Store 结构
{
  userStore: {
    userInfo: {},      // 用户信息
    isLogin: true,     // 登录状态（云开发免登录）
    role: 'customer'   // 角色：customer/admin/staff
  },
  cartStore: {
    items: [],         // 购物车商品
    totalCount: 0,     // 总数量
    totalPrice: 0      // 总价
  },
  appStore: {
    isLoading: false,  // 全局加载状态
    toast: {},         // 提示信息
    modal: {}          // 弹窗信息
  }
}
```

### 3.3 安全规则
```javascript
// 数据库权限设计
{
  products:    '所有人可读，管理员可写',
  orders:      '用户只能读写自己的订单，管理员可读写所有',
  users:       '用户只能读写自己的信息',
  cart:        '用户私有',
  addresses:   '用户私有',
  coupons:     '所有人可读，管理员可写'
}
```
