# 用户头像和昵称功能说明

## 功能概述

已更新"我的"页面的用户头像和昵称显示逻辑：

1. **微信昵称显示** - 登录后优先显示微信昵称
2. **微信头像显示** - 支持使用微信头像，可点击更换
3. **头像选择功能** - 支持在未登录和已登录状态下选择头像

## 修改内容

### 1. 登录流程优化 (`pages/user/user.js`)

登录时自动获取微信用户信息：
- 调用 `wx.getUserProfile` 获取微信昵称和头像
- 将信息保存到服务器和本地
- 页面自动显示微信昵称和头像

### 2. 头像选择功能

支持两种头像选择方式：

**未登录状态：**
- 点击头像区域选择微信头像
- 头像临时保存，登录后自动上传

**已登录状态：**
- 点击头像可更换
- 直接上传到云存储并更新用户信息

### 3. 昵称显示逻辑

显示优先级：
1. 用户设置的昵称 (`userInfo.nickName`)
2. 微信昵称 (`userInfo.wxNickName`)
3. 默认显示 "微信用户"

### 4. 头像显示逻辑

显示优先级：
1. 用户上传的头像 (`userInfo.avatarUrl`)
2. 默认头像 (`/assets/images/avatar-default.png`)

## 测试步骤

### 测试 1：登录时获取微信信息

1. 在未登录状态下进入"我的"页面
2. 点击"微信一键登录"
3. 在授权弹窗中点击"允许"
4. **预期结果**：
   - 登录成功
   - 昵称显示为微信昵称
   - 头像显示为微信头像

### 测试 2：未登录时选择头像

1. 退出登录（如果已登录）
2. 点击头像区域
3. 选择微信头像
4. **预期结果**：
   - 头像显示在选择区域
   - 提示"头像已选择，登录后将自动使用"
   - 登录后自动使用该头像

### 测试 3：已登录时更换头像

1. 在已登录状态下点击头像
2. 选择新的微信头像
3. **预期结果**：
   - 头像上传成功
   - 页面显示新头像
   - 提示"头像更新成功"

### 测试 4：昵称显示

1. 确保已登录且获取了微信信息
2. 查看"我的"页面顶部昵称
3. **预期结果**：显示微信昵称而非"烘焙爱好者"

## 注意事项

1. **授权提示**：首次获取微信信息时会弹出授权窗口，用户需要点击"允许"
2. **拒绝授权处理**：如果用户拒绝授权，将使用默认信息，不影响登录功能
3. **头像存储**：头像上传到云开发的云存储，需要使用云存储权限

## 常见问题

### Q: 为什么登录后没有显示微信昵称？

A: 可能原因：
- 用户拒绝了信息授权
- `wx.getUserProfile` 调用失败
- 云函数更新用户信息失败

**排查方法**：
1. 检查控制台是否有 `[个人中心] 获取到微信用户信息` 日志
2. 检查是否有 `[个人中心] 用户拒绝授权` 日志
3. 检查云函数 `user/updateUserInfo` 是否正常工作

### Q: 头像上传失败怎么办？

A: 检查以下几点：
1. 云存储是否有写入权限
2. 网络连接是否正常
3. 头像文件是否过大（建议不超过 2MB）

### Q: 如何重新获取微信信息？

A: 目前有两种方式：
1. 退出登录后重新登录
2. 点击头像更换时选择新的微信头像

## 技术实现

### 关键 API

- `wx.getUserProfile` - 获取微信用户信息
- `wx.cloud.uploadFile` - 上传头像到云存储
- `wx.cloud.getTempFileURL` - 获取文件临时链接

### 数据结构

```javascript
userInfo: {
  userId: 'xxx',           // 用户ID
  nickName: '微信昵称',     // 昵称（优先显示）
  wxNickName: '微信昵称',   // 微信原始昵称
  avatarUrl: 'https://...', // 头像URL
  phone: '13800138000',    // 手机号
  memberLevel: 0,          // 会员等级
  points: 0                // 积分
}
```

## 后续优化建议

1. 添加昵称编辑功能（输入框修改）
2. 添加更多头像裁剪选项
3. 支持从相册选择头像（不仅是微信头像）
