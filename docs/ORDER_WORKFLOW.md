# æš–å¿ƒçƒ˜ç„™å°ç¨‹åº - è®¢å•å¤„ç†æµç¨‹æ–‡æ¡£

> æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0
> æ›´æ–°æ—¥æœŸï¼š2026-02-28
> é€‚ç”¨ç³»ç»Ÿï¼šæš–å¿ƒçƒ˜ç„™å¾®ä¿¡å°ç¨‹åº

---

## ç›®å½•

1. [æ¦‚è¿°](#ä¸€æ¦‚è¿°)
2. [çŠ¶æ€ç å®šä¹‰](#äºŒçŠ¶æ€ç å®šä¹‰)
3. [ç”¨æˆ·ç«¯è®¢å•æµè½¬](#ä¸‰ç”¨æˆ·ç«¯è®¢å•æµè½¬)
4. [ç®¡ç†å‘˜ç«¯æ“ä½œæµç¨‹](#å››ç®¡ç†å‘˜ç«¯æ“ä½œæµç¨‹)
5. [é…é€ç®¡ç†æµç¨‹](#äº”é…é€ç®¡ç†æµç¨‹)
6. [é€€æ¬¾å¤„ç†æµç¨‹](#å…­é€€æ¬¾å¤„ç†æµç¨‹)
7. [æ•°æ®åº“å­—æ®µè¯´æ˜](#ä¸ƒæ•°æ®åº“å­—æ®µè¯´æ˜)
8. [APIæ¥å£æ¸…å•](#å…«apiæ¥å£æ¸…å•)
9. [å¼‚å¸¸å¤„ç†](#ä¹å¼‚å¸¸å¤„ç†)
10. [é™„å½•](#åé™„å½•)

---

## ä¸€ã€æ¦‚è¿°

### 1.1 è®¢å•ç±»å‹

| ç±»å‹ | é…é€æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| **è‡ªå–è®¢å•** | deliveryType=0 | ç”¨æˆ·åˆ°åº—è‡ªå–ï¼Œæ— é…é€è´¹ |
| **é…é€è®¢å•** | deliveryType=1 | å•†å®¶é…é€ï¼Œé…é€è´¹Â¥5 |
| **çº¿ä¸‹æ”¯ä»˜è®¢å•** | payType='offline' | åˆ°åº—ä»˜æ¬¾ï¼Œç›´æ¥è·³è¿‡æ”¯ä»˜ç¯èŠ‚ |

### 1.2 æ”¯ä»˜æ–¹å¼

| æ”¯ä»˜æ–¹å¼ | payType | è¯´æ˜ |
|----------|---------|------|
| **å¾®ä¿¡æ”¯ä»˜** | 'wechat' | è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API |
| **ç§¯åˆ†æ”¯ä»˜** | 'points' | 1å…ƒ=1ç§¯åˆ†ï¼Œå…¨é¢æŠµæ‰£ |
| **çº¿ä¸‹æ”¯ä»˜** | 'offline' | åˆ°åº—ç°é‡‘/æ‰«ç æ”¯ä»˜ |

---

## äºŒã€çŠ¶æ€ç å®šä¹‰

### 2.1 äº‘å‡½æ•°çŠ¶æ€ç ï¼ˆæ•°æ®åº“å­˜å‚¨ï¼‰

```javascript
const ORDER_STATUS = {
  PENDING_PAY: 0,      // å¾…ä»˜æ¬¾
  PAID: 1,             // å·²æ”¯ä»˜
  PREPARING: 2,        // åˆ¶ä½œä¸­ï¼ˆå¤‡é¤ä¸­ï¼‰
  DELIVERING: 3,       // é…é€ä¸­
  COMPLETED: 4,        // å·²å®Œæˆ
  OFFLINE_PAY: 5,      // çº¿ä¸‹æ”¯ä»˜
  CANCELLED: -1,       // å·²å–æ¶ˆ
  REFUNDING: -2,       // é€€æ¬¾ä¸­
  REFUNDED: -3         // å·²é€€æ¬¾
}
```

### 2.2 çŠ¶æ€æ˜¾ç¤ºæ˜ å°„

| çŠ¶æ€ç  | æ˜¾ç¤ºæ–‡æœ¬ | é¢œè‰²å€¼ | å›¾æ ‡ | é€‚ç”¨é…é€ç±»å‹ |
|--------|----------|--------|------|--------------|
| 0 | å¾…ä»˜æ¬¾ | `#D4A96A` | â° | è‡ªå–/é…é€ |
| 1 | å·²æ”¯ä»˜ | `#4ECDC4` | âœ… | è‡ªå–/é…é€ |
| 2 | åˆ¶ä½œä¸­ | `#AB47BC` | ğŸ³ | è‡ªå–/é…é€ |
| 3 | é…é€ä¸­ | `#29B6F6` | ğŸšš | ä»…é…é€ |
| 4 | å·²å®Œæˆ | `#66BB6A` | âœ“ | è‡ªå–/é…é€ |
| 5 | çº¿ä¸‹æ”¯ä»˜ | `#D4A96A` | ğŸ’µ | è‡ªå–/é…é€ |
| -1 | å·²å–æ¶ˆ | `#9E9E9E` | âœ• | è‡ªå–/é…é€ |
| -2 | é€€æ¬¾ä¸­ | `#EF5350` | â†© | è‡ªå–/é…é€ |
| -3 | å·²é€€æ¬¾ | `#BDBDBD` | â†© | è‡ªå–/é…é€ |

### 2.3 ç”¨æˆ·ç«¯Tabåˆ†ç±»

| Tabåç§° | åŒ…å«çŠ¶æ€ç  | é…é€ç±»å‹è¿‡æ»¤ | æ˜¾ç¤ºè§„åˆ™ |
|---------|------------|--------------|----------|
| å…¨éƒ¨ | æ‰€æœ‰ | æ—  | æ˜¾ç¤ºæ‰€æœ‰è®¢å• |
| å¾…ä»˜æ¬¾ | 0 | æ—  | å¾…ä»˜æ¬¾ |
| å¾…è‡ªå– | 1, 2 | deliveryType=0 | å·²æ”¯ä»˜/åˆ¶ä½œä¸­ |
| å¾…é…é€ | 1, 2, 3 | deliveryType=1 | å·²æ”¯ä»˜/åˆ¶ä½œä¸­/é…é€ä¸­ |
| å·²å®Œæˆ | 4 | æ—  | å·²å®Œæˆ |
| å·²å–æ¶ˆ | -1, -2, -3 | æ—  | å·²å–æ¶ˆ/é€€æ¬¾ä¸­/å·²é€€æ¬¾ |

---

## ä¸‰ã€ç”¨æˆ·ç«¯è®¢å•æµè½¬

### 3.1 è‡ªå–è®¢å•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åˆ›å»ºè®¢å•     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ”¯ä»˜æˆåŠŸ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚
â”‚ å°ç¨‹åº  â”‚   status=0    â”‚ å°ç¨‹åº  â”‚   status=1    â”‚ åˆ¶ä½œä¸­  â”‚
â”‚         â”‚               â”‚         â”‚               â”‚ status=2â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚                          â”‚
     â”‚ 30åˆ†é’Ÿæœªæ”¯ä»˜              â”‚                          â”‚ åˆ¶ä½œå®Œæˆ
     â”‚ ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆ              â”‚                          â”‚
     â†“                          â”‚                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²å–æ¶ˆ  â”‚                    â”‚                   â”‚ å¾…è‡ªå–  â”‚
â”‚(-1)     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ status=2â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â”‚ ç”¨æˆ·åˆ°åº—
                                                         â”‚ ç¡®è®¤å–è´§
                                                         â†“
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚ å·²å®Œæˆ  â”‚
                                                  â”‚ (4)     â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ­¥éª¤ï¼š**

1. **åˆ›å»ºè®¢å•** (status=0)
   - ç”¨æˆ·é€‰æ‹©å•†å“ â†’ ç¡®è®¤è®¢å• â†’ åˆ›å»ºè®¢å•
   - åº“å­˜é¢„æ‰£ï¼ˆäº‹åŠ¡å¤„ç†ï¼‰
   - è®¢å•æœ‰æ•ˆæœŸï¼š30åˆ†é’Ÿ

2. **æ”¯ä»˜è®¢å•** (status=1)
   - å¾®ä¿¡æ”¯ä»˜ï¼šè°ƒèµ·å¾®ä¿¡æ”¯ä»˜API
   - ç§¯åˆ†æ”¯ä»˜ï¼šæ‰£é™¤ç”¨æˆ·ç§¯åˆ†
   - æ”¯ä»˜æˆåŠŸå›è°ƒæ›´æ–°çŠ¶æ€

3. **å•†å®¶åˆ¶ä½œ** (status=2)
   - ç®¡ç†å‘˜åœ¨åå°ç‚¹å‡»"å¤„ç†è®¢å•"
   - é€‰æ‹©"è®¾ä¸ºåˆ¶ä½œä¸­"
   - ç”¨æˆ·ç«¯æ˜¾ç¤º"åˆ¶ä½œä¸­"

4. **ç”¨æˆ·å–è´§** (status=4)
   - åˆ¶ä½œå®Œæˆç­‰å¾…ç”¨æˆ·åˆ°åº—
   - ç”¨æˆ·å‡ºç¤ºå–è´§ç /è®¢å•å·
   - ç®¡ç†å‘˜ç¡®è®¤æˆ–ç”¨æˆ·è‡ªåŠ©ç¡®è®¤

### 3.2 é…é€è®¢å•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åˆ›å»ºè®¢å•     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    æ”¯ä»˜æˆåŠŸ     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚
â”‚ å°ç¨‹åº  â”‚   status=0    â”‚ å°ç¨‹åº  â”‚   status=1    â”‚ åˆ¶ä½œä¸­  â”‚
â”‚         â”‚               â”‚         â”‚               â”‚ status=2â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚                          â”‚
     â”‚ 30åˆ†é’Ÿæœªæ”¯ä»˜              â”‚                          â”‚ åˆ¶ä½œå®Œæˆ
     â”‚ ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆ              â”‚                          â”‚
     â†“                          â”‚                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²å–æ¶ˆ  â”‚                    â”‚                   â”‚ é…é€ä¸­  â”‚
â”‚(-1)     â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ status=3â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â”‚ éª‘æ‰‹é…é€
                                                         â”‚
                                                         â†“
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚ å·²å®Œæˆ  â”‚
                                                  â”‚ (4)     â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ­¥éª¤ï¼š**

1. **åˆ›å»ºè®¢å•** (status=0)
   - é€‰æ‹©é…é€åœ°å€
   - è®¡ç®—é…é€è´¹Â¥5
   - åˆ›å»ºè®¢å•

2. **æ”¯ä»˜è®¢å•** (status=1)
   - åŒè‡ªå–è®¢å•

3. **å•†å®¶åˆ¶ä½œ** (status=2)
   - å•†å®¶åˆ¶ä½œå•†å“
   - æ‰“åŒ…å®Œæˆ

4. **å®‰æ’é…é€** (status=3)
   - ç®¡ç†å‘˜ç‚¹å‡»"å»é…é€"
   - å•†å®¶è‡ªè¡Œé…é€
   - ç”¨æˆ·å¯æŸ¥çœ‹é…é€çŠ¶æ€

5. **é…é€å®Œæˆ** (status=4)
   - é€è¾¾åç®¡ç†å‘˜ç¡®è®¤
   - æˆ–ç”¨æˆ·ç¡®è®¤æ”¶è´§

### 3.3 çº¿ä¸‹æ”¯ä»˜æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    é€‰æ‹©çº¿ä¸‹æ”¯ä»˜   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å•†å®¶ç¡®è®¤     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚
â”‚ å°ç¨‹åº  â”‚   status=5    â”‚ åå°    â”‚   å¼€å§‹åˆ¶ä½œ    â”‚ åˆ¶ä½œä¸­  â”‚
â”‚         â”‚               â”‚         â”‚               â”‚ status=2â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚                          â”‚
     â”‚ å–æ¶ˆè®¢å•                  â”‚ æ‹’ç»è®¢å•                  â”‚ åˆ¶ä½œå®Œæˆ
     â†“                          â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²å–æ¶ˆ  â”‚               â”‚ å·²å–æ¶ˆ  â”‚               â”‚ å¾…å–è´§/ â”‚
â”‚(-1)     â”‚               â”‚(-1)     â”‚               â”‚ é…é€ä¸­  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ­¥éª¤ï¼š**

1. **é€‰æ‹©çº¿ä¸‹æ”¯ä»˜** (status=5)
   - è®¢å•æäº¤æ—¶é€‰æ‹©"åˆ°åº—ä»˜æ¬¾"
   - è®¢å•ç›´æ¥è¿›å…¥å¾…å¤„ç†é˜Ÿåˆ—

2. **å•†å®¶ç¡®è®¤** (status=2)
   - å•†å®¶ç¡®è®¤è®¢å•æœ‰æ•ˆ
   - å¼€å§‹åˆ¶ä½œ

3. **åç»­æµç¨‹**
   - åŒè‡ªå–æˆ–é…é€è®¢å•

---

## å››ã€ç®¡ç†å‘˜ç«¯æ“ä½œæµç¨‹

### 4.1 è®¢å•ç®¡ç†é¡µé¢

**è·¯å¾„ï¼š** `package-admin/pages/order-manage/order-manage`

**åŠŸèƒ½æ¨¡å—ï¼š**
- è®¢å•åˆ—è¡¨ï¼ˆæ”¯æŒç­›é€‰å’Œæœç´¢ï¼‰
- è®¢å•è¯¦æƒ…
- çŠ¶æ€æ›´æ–°
- è”ç³»å®¢æˆ·
- é…é€ç®¡ç†

### 4.2 çŠ¶æ€æ›´æ–°æ“ä½œ

#### 4.2.1 æ›´æ–°è®¢å•çŠ¶æ€

**äº‘å‡½æ•°ï¼š** `admin/updateOrderStatus`

**è¯·æ±‚å‚æ•°ï¼š**
```javascript
{
  action: 'updateOrderStatus',
  orderId: 'è®¢å•ID',
  status: 2,  // ç›®æ ‡çŠ¶æ€ç 
  remark: 'æ“ä½œå¤‡æ³¨'  // å¯é€‰
}
```

**çŠ¶æ€æµè½¬è§„åˆ™ï¼š**

| å½“å‰çŠ¶æ€ | å¯æ›´æ–°åˆ° | æ“ä½œ | å¤‡æ³¨ |
|----------|----------|------|------|
| å·²æ”¯ä»˜(1) | åˆ¶ä½œä¸­(2) | ç‚¹å‡»"å¤„ç†è®¢å•"â†’"è®¾ä¸ºåˆ¶ä½œä¸­" | prepareTime |
| åˆ¶ä½œä¸­(2) | é…é€ä¸­(3) | ç‚¹å‡»"å»é…é€" | deliverTime |
| é…é€ä¸­(3) | å·²å®Œæˆ(4) | ç‚¹å‡»"å·²å®Œæˆ" | completeTime |
| å·²æ”¯ä»˜(1) | å·²å–æ¶ˆ(-1) | ç‚¹å‡»"å–æ¶ˆè®¢å•" | cancelTime |
| åˆ¶ä½œä¸­(2) | å·²å–æ¶ˆ(-1) | ç‚¹å‡»"å–æ¶ˆè®¢å•" | éœ€é€€æ¬¾ |
| ä»»æ„ | é€€æ¬¾ä¸­(-2) | ç”¨æˆ·ç”³è¯·é€€æ¬¾ | refundTime |
| é€€æ¬¾ä¸­(-2) | å·²é€€æ¬¾(-3) | åŒæ„é€€æ¬¾ | å®Œæˆé€€æ¬¾ |

**çŠ¶æ€æ›´æ–°ä»£ç ç¤ºä¾‹ï¼š**
```javascript
// cloudfunctions/admin/index.js
async function updateOrderStatus(data) {
  const { orderId, status, remark } = data

  const updateData = {
    status: status,
    updateTime: now
  }

  // æ ¹æ®çŠ¶æ€è®¾ç½®å¯¹åº”æ—¶é—´å­—æ®µ
  if (status === ORDER_STATUS.PREPARING) {
    updateData.prepareTime = now
  } else if (status === ORDER_STATUS.DELIVERING) {
    updateData.deliverTime = now
  } else if (status === ORDER_STATUS.COMPLETED) {
    updateData.completeTime = now
  }

  // è®°å½•æ“ä½œæ—¥å¿—
  await db.collection('adminLogs').add({
    data: {
      type: 'order',
      action: 'updateStatus',
      orderId: orderId,
      oldStatus: orderResult.data.status,
      newStatus: status,
      remark: remark || '',
      createTime: now,
      operator: OPENID
    }
  })

  await db.collection('orders').doc(orderId).update({
    data: updateData
  })
}
```

#### 4.2.2 è®¢å•ç­›é€‰

**ç­›é€‰æ¡ä»¶ï¼š**
- å…¨éƒ¨è®¢å•
- å¾…å¤„ç†ï¼ˆstatus=1ï¼‰
- åˆ¶ä½œä¸­ï¼ˆstatus=2ï¼‰
- é…é€ä¸­ï¼ˆstatus=3ï¼‰
- å·²å®Œæˆï¼ˆstatus=4ï¼‰
- å·²å–æ¶ˆï¼ˆstatus=-1ï¼‰

**æœç´¢åŠŸèƒ½ï¼š**
- æŒ‰è®¢å•å·æœç´¢
- æŒ‰æ‰‹æœºå·æœç´¢
- æŒ‰ç”¨æˆ·åæœç´¢

### 4.3 è®¢å•è¯¦æƒ…é¡µé¢

**è·¯å¾„ï¼š** `package-admin/pages/order-detail/order-detail`

**æ˜¾ç¤ºä¿¡æ¯ï¼š**
- è®¢å•åŸºæœ¬ä¿¡æ¯ï¼ˆè®¢å•å·ã€çŠ¶æ€ã€æ—¶é—´ï¼‰
- å•†å“æ¸…å•
- é‡‘é¢æ˜ç»†ï¼ˆå•†å“é‡‘é¢ã€é…é€è´¹ã€ä¼˜æƒ ã€å®ä»˜ï¼‰
- ç”¨æˆ·ä¿¡æ¯
- é…é€ä¿¡æ¯
- æ“ä½œæ—¥å¿—

**å¯æ“ä½œæŒ‰é’®ï¼š**
- è”ç³»å®¢æˆ·
- å¤„ç†è®¢å•ï¼ˆçŠ¶æ€æµè½¬ï¼‰
- æ‰“å°è®¢å•
- å–æ¶ˆè®¢å•

---

## äº”ã€é…é€ç®¡ç†æµç¨‹

> **æ³¨æ„ï¼š** å½“å‰ç‰ˆæœ¬ä¸ºç®€åŒ–ç‰ˆé…é€æµç¨‹ï¼Œå•†å®¶è‡ªè¡Œé…é€ï¼Œä¸åˆ†é…ç‰¹å®šé…é€å‘˜ã€‚

### 5.1 é…é€æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    åˆ¶ä½œå®Œæˆ      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å¼€å§‹é…é€     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•†å®¶   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç”¨æˆ·   â”‚
â”‚ åå°    â”‚               â”‚ åå°    â”‚               â”‚ ç­‰å¾…    â”‚
â”‚         â”‚   status=2    â”‚ ç‚¹å‡»    â”‚   status=3    â”‚         â”‚
â”‚         â”‚               â”‚ "å»é…é€" â”‚               â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚                          â”‚
     â”‚                          â”‚ å•†å®¶è‡ªè¡Œé…é€               â”‚ é€è¾¾
     â”‚                          â”‚                           â”‚
     â†“                          â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ¶ä½œä¸­  â”‚               â”‚ é…é€ä¸­  â”‚               â”‚ ç¡®è®¤    â”‚
â”‚ (2)     â”‚               â”‚ (3)     â”‚               â”‚ æ”¶è´§    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â†“
                                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                  â”‚ å·²å®Œæˆ  â”‚
                                                  â”‚ (4)     â”‚
                                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é…é€çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | è¯´æ˜ | æ“ä½œ |
|------|------|------|
| åˆ¶ä½œä¸­(2) | å•†å®¶æ­£åœ¨åˆ¶ä½œå•†å“ | åˆ¶ä½œå®Œæˆåç‚¹å‡»"å»é…é€" |
| é…é€ä¸­(3) | å•†å®¶æ­£åœ¨é…é€é€”ä¸­ | é€è¾¾åç‚¹å‡»"å·²å®Œæˆ" |
| å·²å®Œæˆ(4) | è®¢å•å®Œæˆ | - |

### 5.3 é…é€ç®¡ç†é¡µé¢

**è·¯å¾„ï¼š** `package-admin/pages/delivery-manage/delivery-manage`

**åŠŸèƒ½ï¼š**
- æŸ¥çœ‹å¾…é…é€è®¢å•åˆ—è¡¨
- æŸ¥çœ‹é…é€åœ°å€å’Œè”ç³»ä¿¡æ¯
- ä¸€é”®å¯¼èˆªåˆ°ç”¨æˆ·åœ°å€
- ä¸€é”®æ‹¨æ‰“ç”¨æˆ·ç”µè¯
- ç¡®è®¤é…é€å®Œæˆ

**æ³¨æ„ï¼š** æœªæ¥ç‰ˆæœ¬å¯æ‰©å±•ä¸ºå¤šé…é€å‘˜ç®¡ç†ï¼Œå½“å‰ç‰ˆæœ¬ç”±å•†å®¶è‡ªè¡Œå®Œæˆé…é€ã€‚

---

## å…­ã€é€€æ¬¾å¤„ç†æµç¨‹

### 6.1 é€€æ¬¾ç”³è¯·

**è§¦å‘æ¡ä»¶ï¼š**
- è®¢å•çŠ¶æ€ï¼šå·²æ”¯ä»˜(1) æˆ– åˆ¶ä½œä¸­(2)
- ç”¨æˆ·ä¸»åŠ¨ç”³è¯·
- æˆ–å•†å®¶å–æ¶ˆè®¢å•

**é€€æ¬¾æµç¨‹ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ç”³è¯·é€€æ¬¾     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å•†å®¶å®¡æ ¸     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  å•†å®¶   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚  ç”¨æˆ·   â”‚
â”‚ å°ç¨‹åº  â”‚   status=-2   â”‚ åå°    â”‚               â”‚ å°ç¨‹åº  â”‚
â”‚         â”‚               â”‚         â”‚ åŒæ„/æ‹’ç»      â”‚         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                          â”‚                          â”‚
     â”‚                          â”‚ åŒæ„é€€æ¬¾                  â”‚ é€€æ¬¾åˆ°è´¦
     â”‚                          â†“                          â”‚
     â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
     â”‚                   â”‚  å·²é€€æ¬¾(-3)  â”‚                   â”‚
     â”‚                   â”‚             â”‚                   â”‚
     â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
     â”‚                                                     â”‚
     â”‚                          â”‚ æ‹’ç»é€€æ¬¾                  â”‚
     â”‚                          â†“                          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚  æ¢å¤åŸçŠ¶æ€  â”‚
                         â”‚ (1)æˆ–(2)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 é€€æ¬¾é‡‘é¢è®¡ç®—

| åœºæ™¯ | é€€æ¬¾é‡‘é¢ | è¯´æ˜ |
|------|----------|------|
| æœªåˆ¶ä½œå–æ¶ˆ | å…¨é¢é€€æ¬¾ | å•†å“é‡‘é¢+é…é€è´¹ |
| åˆ¶ä½œä¸­å–æ¶ˆ | åå•†é€€æ¬¾ | å¯èƒ½æ‰£é™¤åˆ¶ä½œæˆæœ¬ |
| é…é€ä¸­å–æ¶ˆ | åå•†é€€æ¬¾ | å¯èƒ½æ‰£é™¤é…é€è´¹ |

### 6.3 åº“å­˜æ¢å¤

**å–æ¶ˆ/é€€æ¬¾æ—¶è‡ªåŠ¨æ¢å¤åº“å­˜ï¼š**
```javascript
// æ¢å¤åº“å­˜é€»è¾‘
for (const item of order.products) {
  if (item.specId) {
    // æ¢å¤è§„æ ¼åº“å­˜
    await transaction.collection('products').doc(item.productId).update({
      data: {
        [`specs.${specIndex}.stock`]: _.inc(item.quantity)
      }
    })
  } else {
    // æ¢å¤å•†å“åº“å­˜
    await transaction.collection('products').doc(item.productId).update({
      data: {
        stock: _.inc(item.quantity)
      }
    })
  }
}
```

---

## ä¸ƒã€æ•°æ®åº“å­—æ®µè¯´æ˜

### 7.1 orders é›†åˆï¼ˆè®¢å•ä¸»è¡¨ï¼‰

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `_id` | String | è®¢å•IDï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰ |
| `orderNo` | String | è®¢å•å·ï¼ˆä¸šåŠ¡ç¼–å·ï¼‰ |
| `userId` | String | ç”¨æˆ·openid |
| `status` | Number | è®¢å•çŠ¶æ€ç  |
| `products` | Array | å•†å“æ˜ç»† |
| `totalAmount` | Number | å•†å“æ€»ä»· |
| `deliveryFee` | Number | é…é€è´¹ |
| `discountAmount` | Number | ä¼˜æƒ é‡‘é¢ |
| `payAmount` | Number | å®ä»˜é‡‘é¢ |
| `deliveryType` | Number | é…é€ç±»å‹ 0è‡ªå– 1é…é€ |
| `address` | Object | é…é€åœ°å€ |
| `pickupTime` | String | è‡ªå–æ—¶é—´ |
| `remark` | String | ç”¨æˆ·å¤‡æ³¨ |
| `couponId` | String | ä¼˜æƒ åˆ¸ID |
| `userCouponId` | String | ç”¨æˆ·ä¼˜æƒ åˆ¸è®°å½•ID |
| `pointsDeducted` | Number | æŠµæ‰£ç§¯åˆ† |
| `payType` | String | æ”¯ä»˜æ–¹å¼ |
| `payTime` | Date | æ”¯ä»˜æ—¶é—´ |
| `prepareTime` | Date | å¼€å§‹åˆ¶ä½œæ—¶é—´ |
| `deliverTime` | Date | é…é€æ—¶é—´ |
| `completeTime` | Date | å®Œæˆæ—¶é—´ |
| `cancelTime` | Date | å–æ¶ˆæ—¶é—´ |
| `refundTime` | Date | é€€æ¬¾æ—¶é—´ |
| `createTime` | Date | åˆ›å»ºæ—¶é—´ |
| `updateTime` | Date | æ›´æ–°æ—¶é—´ |

### 7.2 è®¢å•å•†å“æ˜ç»†ç»“æ„

```javascript
{
  productId: 'å•†å“ID',
  specId: 'è§„æ ¼ID',
  name: 'å•†å“åç§°',
  specName: 'è§„æ ¼åç§°',
  price: 18.00,
  quantity: 2,
  totalAmount: 36.00
}
```

### 7.3 åœ°å€æ•°æ®ç»“æ„

```javascript
{
  name: 'æ”¶è´§äººå§“å',
  phone: '13800138000',
  province: 'çœ',
  city: 'å¸‚',
  district: 'åŒº',
  detail: 'è¯¦ç»†åœ°å€',
  fullAddress: 'å®Œæ•´åœ°å€å­—ç¬¦ä¸²'
}
```

---

## å…«ã€APIæ¥å£æ¸…å•

### 8.1 ç”¨æˆ·ç«¯API

| æ¥å£ | äº‘å‡½æ•° | å‚æ•° | è¯´æ˜ |
|------|--------|------|------|
| åˆ›å»ºè®¢å• | `order/create` | products, addressId, deliveryType, userCouponId | åˆ›å»ºæ–°è®¢å• |
| è·å–è®¢å•åˆ—è¡¨ | `order/getList` | status, filter, page, pageSize | æŸ¥è¯¢è®¢å•åˆ—è¡¨ |
| è·å–è®¢å•è¯¦æƒ… | `order/getDetail` | orderId | æŸ¥è¯¢è®¢å•è¯¦æƒ… |
| å–æ¶ˆè®¢å• | `order/cancel` | orderId | ç”¨æˆ·å–æ¶ˆè®¢å• |
| ç¡®è®¤æ”¶è´§ | `order/confirmReceive` | orderId | ç¡®è®¤æ”¶è´§ |
| å¾®ä¿¡æ”¯ä»˜ | `pay/unifiedOrder` | orderId | å¾®ä¿¡æ”¯ä»˜ä¸‹å• |
| ç§¯åˆ†æ”¯ä»˜ | `order/payWithPoints` | orderId | ç§¯åˆ†æ”¯ä»˜ |
| çº¿ä¸‹æ”¯ä»˜ | `order/offlinePay` | orderId | é€‰æ‹©çº¿ä¸‹æ”¯ä»˜ |
| ç”³è¯·é€€æ¬¾ | `order/applyRefund` | orderId, reason | ç”³è¯·é€€æ¬¾ |

### 8.2 ç®¡ç†å‘˜ç«¯API

| æ¥å£ | äº‘å‡½æ•° | å‚æ•° | è¯´æ˜ |
|------|--------|------|------|
| è·å–è®¢å•åˆ—è¡¨ | `admin/orderManage` | operation: 'getList', filter | è·å–è®¢å•åˆ—è¡¨ |
| è·å–è®¢å•è¯¦æƒ… | `admin/orderManage` | operation: 'getDetail', orderId | è·å–è®¢å•è¯¦æƒ… |
| æ›´æ–°è®¢å•çŠ¶æ€ | `admin/updateOrderStatus` | orderId, status, remark | æ›´æ–°è®¢å•çŠ¶æ€ |
| è·å–ç»Ÿè®¡æ•°æ® | `admin/getStatistics` | startDate, endDate | è·å–ç»Ÿè®¡æ•°æ® |

### 8.3 æ”¯ä»˜å›è°ƒ

| æ¥å£ | äº‘å‡½æ•° | è¯´æ˜ |
|------|--------|------|
| æ”¯ä»˜ç»“æœé€šçŸ¥ | `pay/notify` | å¾®ä¿¡æ”¯ä»˜å›è°ƒ |

---

## ä¹ã€å¼‚å¸¸å¤„ç†

### 9.1 åº“å­˜ä¸è¶³

**åœºæ™¯ï¼š** ç”¨æˆ·ä¸‹å•æ—¶åº“å­˜ä¸è¶³
**å¤„ç†ï¼š** è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œé˜»æ­¢è®¢å•åˆ›å»º
**ä»£ç ï¼š**
```javascript
if (stock < item.quantity) {
  return { code: -1, message: `åº“å­˜ä¸è¶³: ${product.name}` }
}
```

### 9.2 è®¢å•è¶…æ—¶

**åœºæ™¯ï¼š** 30åˆ†é’Ÿæœªæ”¯ä»˜
**å¤„ç†ï¼š** ç³»ç»Ÿè‡ªåŠ¨å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜
**è§¦å‘ï¼š** å®šæ—¶ä»»åŠ¡æˆ–æŸ¥è¯¢æ—¶æ£€æŸ¥

### 9.3 æ”¯ä»˜è¶…æ—¶

**åœºæ™¯ï¼š** å¾®ä¿¡æ”¯ä»˜æœªåœ¨æœ‰æ•ˆæœŸå†…å®Œæˆ
**å¤„ç†ï¼š** è®¢å•çŠ¶æ€ä¿æŒå¾…ä»˜æ¬¾ï¼Œç­‰å¾…é‡æ–°æ”¯ä»˜æˆ–è‡ªåŠ¨å–æ¶ˆ

### 9.4 å¹¶å‘é—®é¢˜

**åœºæ™¯ï¼š** å¤šä¸ªç”¨æˆ·åŒæ—¶è´­ä¹°åŒä¸€å•†å“
**å¤„ç†ï¼š** ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯åº“å­˜æ‰£å‡çš„åŸå­æ€§

```javascript
const transaction = await db.startTransaction()
try {
  // æ‰£å‡åº“å­˜
  await transaction.collection('products').doc(productId).update({
    data: { stock: _.inc(-quantity) }
  })
  // åˆ›å»ºè®¢å•
  await transaction.collection('orders').add({ data: orderData })
  await transaction.commit()
} catch (err) {
  await transaction.rollback()
  return { code: -1, message: 'è®¢å•åˆ›å»ºå¤±è´¥' }
}
```

---

## åã€é™„å½•

### 10.1 è®¢å•å·ç”Ÿæˆè§„åˆ™

```javascript
function generateOrderNo() {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  const hour = String(now.getHours()).padStart(2, '0')
  const minute = String(now.getMinutes()).padStart(2, '0')
  const second = String(now.getSeconds()).padStart(2, '0')
  const random = String(Math.floor(Math.random() * 1000000)).padStart(6, '0')

  return `${year}${month}${day}${hour}${minute}${second}${random}`
  // ç¤ºä¾‹: 20260301123045123456
}
```

### 10.2 ç›¸å…³æ–‡ä»¶è·¯å¾„

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| è®¢å•äº‘å‡½æ•° | `cloudfunctions/order/index.js` | ç”¨æˆ·ç«¯è®¢å•æ“ä½œ |
| æ”¯ä»˜äº‘å‡½æ•° | `cloudfunctions/pay/index.js` | æ”¯ä»˜ç›¸å…³ |
| ç®¡ç†å‘˜äº‘å‡½æ•° | `cloudfunctions/admin/index.js` | ç®¡ç†å‘˜æ“ä½œ |
| ç”¨æˆ·è®¢å•é¡µé¢ | `pages/order/order.js` | ç”¨æˆ·è®¢å•åˆ—è¡¨ |
| è®¢å•ç¡®è®¤é¡µ | `miniprogram/pages/order-confirm/order-confirm.js` | ä¸‹å•é¡µé¢ |
| ç®¡ç†å‘˜è®¢å•ç®¡ç† | `package-admin/pages/order-manage/order-manage.js` | åå°è®¢å•ç®¡ç† |
| è®¢å•è¯¦æƒ…é¡µ | `package-admin/pages/order-detail/order-detail.js` | åå°è®¢å•è¯¦æƒ… |
| å¸¸é‡å®šä¹‰ | `utils/constants.js` | çŠ¶æ€ç å®šä¹‰ |

### 10.3 æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2026-02-28 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ•´åˆè®¢å•å¤„ç†æµç¨‹æ–‡æ¡£ |

---

**æ–‡æ¡£ç»“æŸ**
