# 登录逻辑测试指南

## 修复内容

1. **修复了 `app.js` 的 `checkLoginStatus`** - 现在优先使用本地登录状态，避免因云函数调用失败而错误清除登录状态
2. **优化了 `pages/user/user.js` 的 `checkLoginStatus`** - 添加异步刷新用户信息功能
3. **修复了 `auth.js` 的 `doLogin`** - 确保 `userInfo` 只包含用户信息字段

## 测试步骤

### 测试 1：登录后进入"我的"页面

1. 清除微信开发者工具的缓存（清缓存 → 清除数据缓存）
2. 重新编译小程序
3. 点击"我的" tab
4. 应该看到登录界面（未登录状态）
5. 点击"微信一键登录"按钮完成登录
6. 登录成功后，页面应该自动显示个人中心（已登录状态）
7. 切换到其他 tab（如"首页"）
8. 再次点击"我的" tab
9. **预期结果**：应该显示个人中心页面（不是登录页面）

### 测试 2：重启后保持登录状态

1. 完成登录
2. 关闭微信开发者工具模拟器
3. 重新启动模拟器
4. 点击"我的" tab
5. **预期结果**：应该保持登录状态，显示个人中心

### 测试 3：从其他页面登录后进入"我的"

1. 在未登录状态下，进入需要登录的页面（如"收货地址"）
2. 系统应该自动跳转到登录页面
3. 完成登录
4. 返回到"我的"页面
5. **预期结果**："我的"页面应该显示已登录状态

### 测试 4：退出登录

1. 在"我的"页面（已登录状态）
2. 点击"退出登录"
3. **预期结果**：页面应该切换到未登录状态，显示登录按钮

## 常见问题排查

### 问题：登录后点击"我的"仍然显示登录页面

**排查步骤**：
1. 打开开发者工具控制台
2. 查看日志输出：
   - `[个人中心] 本地登录状态:` 应该显示 `true`
   - `[个人中心] 本地用户信息:` 应该显示用户信息对象
3. 如果显示 `false` 或 `null`，检查：
   - 登录时是否有错误日志
   - 云函数是否正确部署

### 问题：重启后登录状态丢失

**排查步骤**：
1. 检查登录时是否调用了 `auth.doLogin()`
2. 检查 `setAuthInfo` 是否成功执行（查看 `[Auth] setAuthInfo:` 日志）
3. 检查 `getAuthInfo` 是否能读取到存储的信息（查看 `[Auth] isLogin check:` 日志）

### 问题：用户信息不完整

**可能原因**：
- 云函数返回的数据格式不正确
- `auth.doLogin` 中的用户信息提取逻辑有误

**解决方法**：
1. 检查云函数返回的数据结构
2. 确保 `userInfo` 包含以下字段：
   - `userId`
   - `nickName`
   - `avatarUrl`
   - `phone`
   - `memberLevel`
   - `points`

## 部署云函数

修改云函数后，需要重新部署：
1. 在微信开发者工具中，右键点击 `cloudfunctions/user` 文件夹
2. 选择 "创建并部署：云端安装依赖"
3. 等待部署完成
4. 测试登录功能

## 日志参考

正常登录流程的日志输出：
```
[个人中心] 页面显示
[个人中心] 检查登录状态...
[个人中心] 本地登录状态: true
[个人中心] 本地用户信息: { nickName: "...", avatarUrl: "...", ... }
[个人中心] 用户信息已刷新
```

如果看到以下日志，说明登录状态丢失：
```
[个人中心] 本地登录状态: false
[个人中心] 本地用户信息: null
```
