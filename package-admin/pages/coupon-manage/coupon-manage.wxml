<!-- ä¼˜æƒ åˆ¸ç®¡ç†é¡µ -->
<view class="coupon-manage-container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡æ  -->
  <view class="stats-bar">
    <view class="stat-item">
      <text class="stat-value">{{stats.total}}</text>
      <text class="stat-label">å…¨éƒ¨ä¼˜æƒ åˆ¸</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{stats.active}}</text>
      <text class="stat-label">è¿›è¡Œä¸­</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{stats.expired}}</text>
      <text class="stat-label">å·²è¿‡æœŸ</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{stats.totalReceived}}</text>
      <text class="stat-label">æ€»é¢†å–</text>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="filter-section">
    <view class="search-box">
      <view class="iconfont icon-search"></view>
      <input
        type="text"
        placeholder="æœç´¢ä¼˜æƒ åˆ¸åç§°"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="onSearch"
      />
      <text class="clear-icon" wx:if="{{searchKeyword}}" bindtap="clearSearch">Ã—</text>
    </view>

    <view class="status-tabs">
      <view class="tab {{currentTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">
        å…¨éƒ¨
      </view>
      <view class="tab {{currentTab === 'active' ? 'active' : ''}}" bindtap="switchTab" data-tab="active">
        è¿›è¡Œä¸­
      </view>
      <view class="tab {{currentTab === 'pending' ? 'active' : ''}}" bindtap="switchTab" data-tab="pending">
        æœªå¼€å§‹
      </view>
      <view class="tab {{currentTab === 'expired' ? 'active' : ''}}" bindtap="switchTab" data-tab="expired">
        å·²ç»“æŸ
      </view>
    </view>
  </view>

  <!-- ä¼˜æƒ åˆ¸åˆ—è¡¨ -->
  <view class="coupon-list">
    <view class="coupon-card {{item.status}}" wx:for="{{coupons}}" wx:key="_id">
      <!-- å·¦ä¾§å½©è‰²æ¡ -->
      <view class="coupon-color-bar"></view>

      <!-- å›¾æ ‡åŒº -->
      <view class="coupon-icon-wrapper" style="background: {{item.iconBg || '#FFF8E1'}};">
        <view class="iconfont icon-gift" style="color: {{item.iconColor || '#D4A96A'}};"></view>
      </view>

      <!-- å†…å®¹åŒº -->
      <view class="coupon-content">
        <!-- æ ‡é¢˜è¡Œ -->
        <view class="coupon-title-row">
          <text class="coupon-name">{{item.title || item.name}}</text>
          <view class="coupon-tag" wx:if="{{item.tag}}" style="background: {{item.tagBg || '#FFF8E1'}}; color: {{item.tagColor || '#D4A96A'}};">{{item.tag}}</view>
          <view class="status-tag {{item.status}}" wx:else>{{item.statusText}}</view>
        </view>

        <!-- ä¼˜æƒ é‡‘é¢ -->
        <view class="coupon-discount" style="color: {{item.amountColor || '#D4A96A'}};">
          <text wx:if="{{item.type === 'amount' || item.discountType === 'amount'}}">æ»¡{{item.minSpend || item.minAmount}}å‡{{item.value || item.amount}}</text>
          <text wx:elif="{{item.type === 'discount' || item.discountType === 'discount'}}">{{item.value || item.amount}}æŠ˜</text>
          <text wx:else>{{item.value || item.amount}}{{item.type === 'amount' ? 'å…ƒ' : 'æŠ˜'}}</text>
        </view>

        <!-- ä½¿ç”¨æ¡ä»¶ -->
        <view class="coupon-condition">
          <text>{{item.desc || item.description}}</text>
        </view>

        <!-- é¢†å–è¿›åº¦ -->
        <view class="coupon-progress" wx:if="{{item.totalCount > 0}}">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(item.receivedCount / item.totalCount) * 100}}%;"></view>
          </view>
          <view class="progress-info">
            <text class="progress-text">å·²é¢† {{item.receivedCount || 0}} äºº</text>
            <text class="progress-text remaining" wx:if="{{item.totalCount - item.receivedCount > 0}}">å‰©ä½™ {{item.totalCount - item.receivedCount}} å¼ </text>
            <text class="progress-text remaining" wx:else>å·²é¢†å®Œ</text>
          </view>
        </view>
        <view class="coupon-status no-limit" wx:else>
          <text wx:if="{{item.status === 'expired'}}">å·²ç»“æŸ Â· å·²é¢†{{item.receivedCount || 0}}äºº</text>
          <text wx:elif="{{item.status === 'pending'}}">æœªå¼€å§‹</text>
          <text wx:else>å·²é¢†å– {{item.receivedCount || 0}} äºº Â· ä¸é™é‡</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’®åŒº -->
      <view class="coupon-actions">
        <view class="action-btn-small distribute" bindtap="openDistributeModal" data-id="{{item._id}}" wx:if="{{item.status !== 'expired'}}">
          <view class="iconfont icon-distribute"></view>
        </view>
        <view class="action-btn-small edit" bindtap="editCoupon" data-id="{{item._id}}">
          <view class="iconfont icon-edit"></view>
        </view>
        <view class="action-btn-small delete" bindtap="deleteCoupon" data-id="{{item._id}}">
          <view class="iconfont icon-delete"></view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{coupons.length === 0 && !isLoading && page === 1}}">
      <image class="empty-image" src="/images/empty-coupon.png" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— ä¼˜æƒ åˆ¸</text>
      <text class="empty-subtext">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®åˆ›å»ºä¼˜æƒ åˆ¸</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{coupons.length > 0 && !isLoading}}">
      <text wx:if="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
      <text wx:else>æ²¡æœ‰æ›´å¤šä¼˜æƒ åˆ¸äº†</text>
    </view>

    <!-- åŠ è½½ä¸­ -->
    <view class="loading-state" wx:if="{{isLoading && page === 1}}">
      <text>åŠ è½½ä¸­...</text>
    </view>
  </view>

  <!-- åº•éƒ¨æ·»åŠ æŒ‰é’® -->
  <view class="add-btn-wrapper">
    <view class="add-btn" bindtap="createCoupon" hover-class="add-btn-hover">
      <view class="iconfont icon-plus"></view>
      <text>æ–°å¢ä¼˜æƒ åˆ¸</text>
    </view>
  </view>

  <!-- åˆ›å»º/ç¼–è¾‘å¼¹çª— -->
  <view class="modal-container" wx:if="{{showModal}}">
    <view class="modal-mask" bindtap="closeModal"></view>
    <view class="modal-box">
      <view class="modal-header">
        <text class="modal-title">{{isEdit ? 'ç¼–è¾‘ä¼˜æƒ åˆ¸' : 'åˆ›å»ºä¼˜æƒ åˆ¸'}}</text>
        <view class="modal-close" bindtap="closeModal">
          <text>Ã—</text>
        </view>
      </view>

      <scroll-view class="modal-scroll" scroll-y>
        <view class="modal-form">
          <!-- ä¼˜æƒ åˆ¸ç±»å‹ -->
          <view class="form-item">
            <view class="form-label">ä¼˜æƒ åˆ¸ç±»å‹</view>
            <view class="type-options">
              <view class="type-option {{formData.type === 'amount' ? 'active' : ''}}" bindtap="selectType" data-type="amount">æ»¡å‡åˆ¸</view>
              <view class="type-option {{formData.type === 'discount' ? 'active' : ''}}" bindtap="selectType" data-type="discount">æŠ˜æ‰£åˆ¸</view>
            </view>
          </view>

          <!-- ä¼˜æƒ åˆ¸åç§° -->
          <view class="form-item">
            <view class="form-label">ä¼˜æƒ åˆ¸åç§°</view>
            <input class="form-input" type="text" placeholder="è¯·è¾“å…¥ä¼˜æƒ åˆ¸åç§°" value="{{formData.name}}" bindinput="onNameInput"/>
          </view>

          <!-- ä¼˜æƒ é‡‘é¢/æŠ˜æ‰£ -->
          <view class="form-item">
            <view class="form-label">{{formData.type === 'amount' ? 'ä¼˜æƒ é‡‘é¢' : 'æŠ˜æ‰£åŠ›åº¦'}}</view>
            <view class="input-wrap">
              <input class="form-input flex1" type="digit" placeholder="{{formData.type === 'amount' ? 'è¯·è¾“å…¥ä¼˜æƒ é‡‘é¢' : 'è¯·è¾“å…¥æŠ˜æ‰£ï¼Œå¦‚8.5'}}" value="{{formData.value}}" bindinput="onValueInput"/>
              <text class="input-unit">{{formData.type === 'discount' ? 'æŠ˜' : 'å…ƒ'}}</text>
            </view>
          </view>

          <!-- æœ€ä½æ¶ˆè´¹ -->
          <view class="form-item">
            <view class="form-label">æœ€ä½æ¶ˆè´¹é‡‘é¢</view>
            <view class="input-wrap">
              <text class="input-unit left">Â¥</text>
              <input class="form-input flex1" type="digit" placeholder="0è¡¨ç¤ºæ— é—¨æ§›" value="{{formData.minSpend}}" bindinput="onMinSpendInput"/>
            </view>
          </view>

          <!-- å‘æ”¾æ€»é‡ -->
          <view class="form-item">
            <view class="form-label">å‘æ”¾æ€»é‡</view>
            <view class="input-wrap">
              <input class="form-input flex1" type="number" placeholder="ä¸å¡«è¡¨ç¤ºä¸é™é‡" value="{{formData.totalCount}}" bindinput="onTotalCountInput"/>
              <text class="input-unit">å¼ </text>
            </view>
          </view>

          <!-- æ¯äººé™é¢† -->
          <view class="form-item">
            <view class="form-label">æ¯äººé™é¢†</view>
            <view class="limit-options">
              <view class="limit-option {{formData.limitPerUser === 1 ? 'active' : ''}}" bindtap="selectLimit" data-limit="1">1å¼ </view>
              <view class="limit-option {{formData.limitPerUser === 2 ? 'active' : ''}}" bindtap="selectLimit" data-limit="2">2å¼ </view>
              <view class="limit-option {{formData.limitPerUser === 5 ? 'active' : ''}}" bindtap="selectLimit" data-limit="5">5å¼ </view>
              <view class="limit-option {{formData.limitPerUser === 0 ? 'active' : ''}}" bindtap="selectLimit" data-limit="0">ä¸é™</view>
            </view>
          </view>

          <!-- æœ‰æ•ˆæœŸ -->
          <view class="form-item">
            <view class="form-label">æœ‰æ•ˆæœŸ</view>
            <view class="date-range">
              <picker mode="date" value="{{formData.startDate}}" bindchange="onStartDateChange">
                <view class="date-picker">{{formData.startDate || 'å¼€å§‹æ—¥æœŸ'}}</view>
              </picker>
              <text class="date-to">è‡³</text>
              <picker mode="date" value="{{formData.endDate}}" bindchange="onEndDateChange">
                <view class="date-picker">{{formData.endDate || 'ç»“æŸæ—¥æœŸ'}}</view>
              </picker>
            </view>
          </view>

          <!-- é€‚ç”¨èŒƒå›´ -->
          <view class="form-item">
            <view class="form-label">é€‚ç”¨èŒƒå›´</view>
            <view class="scope-options">
              <view class="scope-option {{formData.scope === 'all' ? 'active' : ''}}" bindtap="selectScope" data-scope="all">å…¨åº—é€šç”¨</view>
              <view class="scope-option {{formData.scope === 'gift' ? 'active' : ''}}" bindtap="selectScope" data-scope="gift">ä¸“å±ç¤¼åŒ…</view>
              <view class="scope-option {{formData.scope === 'product' ? 'active' : ''}}" bindtap="selectScope" data-scope="product">æŒ‡å®šå•†å“</view>
            </view>
          </view>

          <!-- ä¸“å±ç¤¼åŒ…æç¤º -->
          <view class="form-item" wx:if="{{formData.scope === 'gift'}}">
            <view class="form-tip gift-tip">
              <text class="tip-icon">ğŸ</text>
              <text class="tip-text">ä¸“å±ç¤¼åŒ…ä¼˜æƒ åˆ¸åªåœ¨ç”¨æˆ·ä¼šå‘˜ä¸­å¿ƒçš„"ä¸“å±ç¤¼åŒ…"åŒºåŸŸæ˜¾ç¤º</text>
            </view>
          </view>

          <!-- æŒ‡å®šå•†å“é€‰æ‹© -->
          <view class="form-item" wx:if="{{formData.scope === 'product'}}">
            <view class="form-label">é€‚ç”¨å•†å“</view>
            <view class="product-select-area">
              <view class="product-count" wx:if="{{formData.selectedProducts && formData.selectedProducts.length > 0}}">
                å·²é€‰æ‹© {{formData.selectedProducts.length}} ä»¶å•†å“
              </view>
              <view class="product-empty" wx:else>
                æš‚æœªé€‰æ‹©å•†å“
              </view>
              <!-- å·²é€‰å•†å“å›¾ç‰‡åˆ—è¡¨ -->
              <scroll-view class="selected-products-scroll" scroll-x wx:if="{{formData.selectedProducts && formData.selectedProducts.length > 0}}">
                <view class="selected-product-item" wx:for="{{formData.selectedProducts}}" wx:key="_id">
                  <image class="selected-product-img" src="{{item.images && item.images[0] ? item.images[0] : (item.image || '/images/empty-product.png')}}" mode="aspectFill"/>
                  <text class="selected-product-name">{{item.name}}</text>
                </view>
              </scroll-view>
              <view class="btn-select-product" bindtap="openProductSelector">
                <text class="btn-text">{{formData.selectedProducts && formData.selectedProducts.length > 0 ? 'ä¿®æ”¹å•†å“' : 'é€‰æ‹©å•†å“'}}</text>
              </view>
            </view>
          </view>

          <!-- ä½¿ç”¨è¯´æ˜ -->
          <view class="form-item">
            <view class="form-label">ä½¿ç”¨è¯´æ˜</view>
            <input class="form-input" type="text" placeholder="è¯·è¾“å…¥ä¼˜æƒ åˆ¸ä½¿ç”¨è¯´æ˜" value="{{formData.description}}" bindinput="onDescriptionInput" maxlength="200"/>
            <view class="input-count">{{formData.description.length || 0}}/200</view>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeModal">å–æ¶ˆ</view>
        <view class="btn-confirm {{isSubmitting ? 'loading' : ''}}" bindtap="submitForm">
          {{isSubmitting ? 'å¤„ç†ä¸­...' : (isEdit ? 'ä¿å­˜ä¿®æ”¹' : 'ç«‹å³åˆ›å»º')}}
        </view>
      </view>
    </view>
  </view>

  <!-- å‘æ”¾ä¼˜æƒ åˆ¸å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showDistributeModal}}" bindtap="closeDistributeModal"></view>
  <view class="modal-content-wrapper" wx:if="{{showDistributeModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å‘æ”¾ä¼˜æƒ åˆ¸</text>
        <view class="modal-close" bindtap="closeDistributeModal">
          <view class="iconfont icon-close"></view>
        </view>
      </view>

      <view class="modal-body">
        <!-- ä¼˜æƒ åˆ¸ä¿¡æ¯ -->
        <view class="selected-coupon-info" wx:if="{{distributeCoupon}}">
          <text class="coupon-info-label">å‘æ”¾ä¼˜æƒ åˆ¸ï¼š</text>
          <view class="coupon-info-card">
            <text class="coupon-info-name">{{distributeCoupon.name}}</text>
            <text class="coupon-info-detail">{{distributeCoupon.type === 'amount' ? 'æ»¡å‡åˆ¸ Â¥' + distributeCoupon.value : 'æŠ˜æ‰£åˆ¸ ' + distributeCoupon.value + 'æŠ˜'}}</text>
          </view>
        </view>

        <!-- ç”¨æˆ·æœç´¢ -->
        <view class="form-group">
          <text class="form-label">é€‰æ‹©ç”¨æˆ·</text>
          <view class="user-search-box" wx:if="{{!selectedUser}}">
            <view class="iconfont icon-search"></view>
            <input
              type="text"
              placeholder="è¾“å…¥æ˜µç§°æˆ–æ‰‹æœºå·æœç´¢ç”¨æˆ·"
              value="{{userSearchKeyword}}"
              bindinput="onUserSearchInput"
            />
          </view>

          <!-- æœç´¢ç»“æœ -->
          <view class="user-search-results" wx:if="{{userSearchResults.length > 0}}">
            <view
              class="user-result-item"
              wx:for="{{userSearchResults}}"
              wx:key="_id"
              bindtap="selectUser"
              data-id="{{item._id}}"
            >
              <image class="user-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"/>
              <view class="user-info">
                <text class="user-name">{{item.nickName}}</text>
                <text class="user-phone" wx:if="{{item.phone}}">{{item.phone}}</text>
              </view>
            </view>
          </view>

          <!-- å·²é€‰ç”¨æˆ· -->
          <view class="selected-user-card" wx:if="{{selectedUser}}">
            <image class="user-avatar" src="{{selectedUser.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"/>
            <view class="user-info">
              <text class="user-name">{{selectedUser.nickName}}</text>
              <text class="user-phone" wx:if="{{selectedUser.phone}}">{{selectedUser.phone}}</text>
            </view>
            <text class="clear-user" bindtap="clearSelectedUser">æ›´æ¢</text>
          </view>
        </view>

        <!-- å‘æ”¾æ•°é‡ -->
        <view class="form-group">
          <text class="form-label">å‘æ”¾æ•°é‡</text>
          <view class="count-selector">
            <view class="count-btn {{distributeCount <= 1 ? 'disabled' : ''}}" bindtap="changeDistributeCount" data-delta="-1">-</view>
            <input
              type="number"
              class="count-input"
              value="{{distributeCount}}"
              bindinput="onDistributeCountInput"
            />
            <view class="count-btn" bindtap="changeDistributeCount" data-delta="1">+</view>
          </view>
          <text class="form-hint" wx:if="{{distributeCoupon}}">
            æ¯äººé™é¢†{{distributeCoupon.limitPerUser || 'ä¸é™'}}å¼ ï¼Œå‰©ä½™{{distributeCoupon.totalCount > 0 ? distributeCoupon.totalCount - distributeCoupon.receivedCount : 'å……è¶³'}}
          </text>
        </view>
      </view>

      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeDistributeModal">å–æ¶ˆ</view>
        <view class="btn-confirm {{isDistributing ? 'loading' : ''}}" bindtap="doDistribute">
          <text wx:if="{{!isDistributing}}">ç¡®è®¤å‘æ”¾</text>
          <text wx:else>å‘æ”¾ä¸­...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å‘æ”¾è®°å½•å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showRecordsModal}}" bindtap="closeRecordsModal"></view>
  <view class="modal-content-wrapper" wx:if="{{showRecordsModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å‘æ”¾è®°å½•</text>
        <view class="modal-close" bindtap="closeRecordsModal">
          <view class="iconfont icon-close"></view>
        </view>
      </view>

      <scroll-view class="modal-body records-list" scroll-y bindscrolltolower="loadMoreRecords">
        <view class="record-item" wx:for="{{distributionRecords}}" wx:key="_id">
          <image class="record-avatar" src="{{item.userAvatar || '/images/default-avatar.png'}}" mode="aspectFill"/>
          <view class="record-info">
            <text class="record-user">{{item.userName}}</text>
            <text class="record-phone" wx:if="{{item.userPhone}}">{{item.userPhone}}</text>
            <text class="record-time">{{item.createTime}}</text>
          </view>
          <view class="record-status {{item.status === 0 ? 'unused' : (item.status === 1 ? 'used' : 'expired')}}">
            {{item.status === 0 ? 'æœªä½¿ç”¨' : (item.status === 1 ? 'å·²ä½¿ç”¨' : 'å·²è¿‡æœŸ')}}
          </view>
        </view>

        <view class="records-empty" wx:if="{{distributionRecords.length === 0 && !isLoadingRecords}}">
          <text>æš‚æ— å‘æ”¾è®°å½•</text>
        </view>

        <view class="records-loading" wx:if="{{isLoadingRecords}}">
          <text>åŠ è½½ä¸­...</text>
        </view>

        <view class="records-no-more" wx:if="{{distributionRecords.length > 0 && !recordsHasMore}}">
          <text>æ²¡æœ‰æ›´å¤šè®°å½•äº†</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- å›æ”¶ä¼˜æƒ åˆ¸å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showRecallModal}}" bindtap="closeRecallModal"></view>
  <view class="modal-content-wrapper" wx:if="{{showRecallModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å›æ”¶ä¼˜æƒ åˆ¸</text>
        <view class="modal-close" bindtap="closeRecallModal">
          <view class="iconfont icon-close"></view>
        </view>
      </view>

      <view class="modal-body">
        <!-- ä¼˜æƒ åˆ¸ä¿¡æ¯ -->
        <view class="recall-info" wx:if="{{recallCoupon}}">
          <text class="recall-info-title">å›æ”¶ä¼˜æƒ åˆ¸ï¼š</text>
          <view class="coupon-info-card">
            <text class="coupon-info-name">{{recallCoupon.name}}</text>
            <text class="coupon-info-detail">{{recallCoupon.type === 'amount' ? 'æ»¡å‡åˆ¸ Â¥' + recallCoupon.value : 'æŠ˜æ‰£åˆ¸ ' + recallCoupon.value + 'æŠ˜'}}</text>
          </view>
          <view class="recall-info-item">
            <text class="recall-info-label">æœªä½¿ç”¨æ•°é‡</text>
            <text class="recall-info-value">{{recallCoupon.receivedCount - recallCoupon.usedCount}}å¼ </text>
          </view>
        </view>

        <!-- å¯å›æ”¶è®°å½•åˆ—è¡¨ -->
        <view class="form-group" wx:if="{{recallableRecords.length > 0}}">
          <text class="form-label">é€‰æ‹©è¦å›æ”¶çš„è®°å½•</text>
          <scroll-view scroll-y class="user-search-results" style="max-height: 400rpx;">
            <view
              class="user-result-item"
              wx:for="{{recallableRecords}}"
              wx:key="_id"
              bindtap="selectRecallRecord"
              data-id="{{item._id}}"
              style="background: {{recallRecord && recallRecord._id === item._id ? '#E8F5E9' : ''}}; border: {{recallRecord && recallRecord._id === item._id ? '2rpx solid #4caf50' : 'none'}};"
            >
              <image class="user-avatar" src="{{item.userAvatar || '/images/default-avatar.png'}}" mode="aspectFill"/>
              <view class="user-info">
                <text class="user-name">{{item.userName}}</text>
                <text class="user-phone" wx:if="{{item.userPhone}}">{{item.userPhone}}</text>
                <text class="record-time">å‘æ”¾æ—¶é—´ï¼š{{item.createTime}}</text>
              </view>
              <view class="record-status unused">æœªä½¿ç”¨</view>
            </view>
          </scroll-view>
        </view>

        <view class="recall-warning" wx:if="{{!recallableRecords || recallableRecords.length === 0}}">
          <text>æš‚æ— å¯å›æ”¶çš„ä¼˜æƒ åˆ¸</text>
        </view>

        <view class="recall-warning" wx:if="{{recallRecord}}" style="margin-top: 20rpx;">
          <text>âš ï¸ å›æ”¶åè¯¥ç”¨æˆ·å°†æ— æ³•ä½¿ç”¨æ­¤ä¼˜æƒ åˆ¸</text>
        </view>
      </view>

      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeRecallModal">å–æ¶ˆ</view>
        <view class="btn-confirm {{isRecalling ? 'loading' : ''}}" bindtap="doRecall" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);" wx:if="{{recallableRecords.length > 0}}">
          <text wx:if="{{!isRecalling}}">ç¡®è®¤å›æ”¶</text>
          <text wx:else>å›æ”¶ä¸­...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æ‰¹é‡å‘æ”¾å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showBatchDistributeModal}}" bindtap="closeBatchDistributeModal"></view>
  <view class="modal-content-wrapper" wx:if="{{showBatchDistributeModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">æ‰¹é‡å‘æ”¾ä¼˜æƒ åˆ¸</text>
        <view class="modal-close" bindtap="closeBatchDistributeModal">
          <view class="iconfont icon-close"></view>
        </view>
      </view>

      <view class="modal-body">
        <!-- ä¼˜æƒ åˆ¸ä¿¡æ¯ -->
        <view class="selected-coupon-info" wx:if="{{distributeCoupon}}">
          <text class="coupon-info-label">æ‰¹é‡å‘æ”¾ä¼˜æƒ åˆ¸ï¼š</text>
          <view class="coupon-info-card">
            <text class="coupon-info-name">{{distributeCoupon.name}}</text>
            <text class="coupon-info-detail">{{distributeCoupon.type === 'amount' ? 'æ»¡å‡åˆ¸ Â¥' + distributeCoupon.value : 'æŠ˜æ‰£åˆ¸ ' + distributeCoupon.value + 'æŠ˜'}}</text>
          </view>
        </view>

        <!-- å‘æ”¾è¯´æ˜ -->
        <view class="form-group">
          <text class="form-label">å‘æ”¾è¯´æ˜</text>
          <view class="recall-info" style="background: #E8F5E9; border: 2rpx solid #4caf50;">
            <text style="font-size: 26rpx; color: #333; display: block; margin-bottom: 12rpx;">å°†è‡ªåŠ¨å‘æ”¾ç»™æ‰€æœ‰æ³¨å†Œç”¨æˆ·</text>
            <text style="font-size: 24rpx; color: #666; display: block;">â€¢ æ¯äººé™é¢† {{distributeCoupon.limitPerUser || 'ä¸é™'}} å¼ </text>
            <text style="font-size: 24rpx; color: #666; display: block;" wx:if="{{distributeCoupon.totalCount > 0}}">â€¢ å‰©ä½™åº“å­˜ {{distributeCoupon.totalCount - distributeCoupon.receivedCount}} å¼ </text>
          </view>
        </view>

        <view class="recall-warning">
          <text>âš ï¸ è¯·ç¡®è®¤ä¼˜æƒ åˆ¸è®¾ç½®æ­£ç¡®åå†è¿›è¡Œæ‰¹é‡å‘æ”¾</text>
        </view>
      </view>

      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeBatchDistributeModal">å–æ¶ˆ</view>
        <view class="btn-confirm {{isDistributing ? 'loading' : ''}}" bindtap="doBatchDistribute">
          <text wx:if="{{!isDistributing}}">ç¡®è®¤æ‰¹é‡å‘æ”¾</text>
          <text wx:else>å‘æ”¾ä¸­...</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å•†å“é€‰æ‹©å¼¹çª— -->
  <view class="modal-container product-selector-modal" wx:if="{{showProductSelector}}">
    <view class="modal-mask" bindtap="closeProductSelector"></view>
    <view class="modal-box product-selector-box">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©é€‚ç”¨å•†å“</text>
        <view class="modal-close" bindtap="closeProductSelector">
          <view class="iconfont icon-close"></view>
        </view>
      </view>

      <view class="modal-scroll product-selector-scroll">
        <!-- æœç´¢å•†å“ -->
        <view class="product-search-wrap">
          <input class="product-search-input" type="text" placeholder="æœç´¢å•†å“åç§°" value="{{productSearchKeyword}}" bindinput="onProductSearchInput"/>
          <view class="product-search-btn" bindtap="searchProducts">æœç´¢</view>
        </view>

        <!-- å·²é€‰æ‹©æç¤º -->
        <view class="selected-tip" wx:if="{{tempSelectedProducts.length > 0}}">
          <text class="tip-text">å·²é€‰æ‹© {{tempSelectedProducts.length}} ä»¶å•†å“</text>
          <text class="tip-action" bindtap="clearAllProducts">æ¸…ç©º</text>
        </view>

        <!-- å•†å“åˆ—è¡¨ -->
        <scroll-view class="product-list" scroll-y bindscrolltolower="loadMoreProducts">
          <view
            class="product-item {{item.selected ? 'selected' : ''}}"
            wx:for="{{productList}}"
            wx:key="_id"
            bindtap="toggleProductSelect"
            data-id="{{item._id}}"
          >
            <image class="product-image" src="{{item.image || (item.images && item.images[0]) || '/images/empty-product.png'}}" mode="aspectFill"/>
            <view class="product-info">
              <text class="product-name">{{item.name}}</text>
              <text class="product-price">Â¥{{item.price}}</text>
            </view>
            <view class="product-checkbox">
              <view class="checkbox-icon {{item.selected ? 'checked' : ''}}">
                <text wx:if="{{item.selected}}">âœ“</text>
              </view>
            </view>
          </view>

          <view class="product-empty" wx:if="{{productList.length === 0 && !isLoadingProducts}}">
            <text>æš‚æ— å•†å“</text>
          </view>

          <view class="product-loading" wx:if="{{isLoadingProducts}}">
            <text>åŠ è½½ä¸­...</text>
          </view>
        </scroll-view>
      </view>

      <view class="modal-footer">
        <view class="btn-cancel" bindtap="closeProductSelector">å–æ¶ˆ</view>
        <view class="btn-confirm" bindtap="confirmProductSelect">
          ç¡®è®¤é€‰æ‹©({{tempSelectedProducts.length}})
        </view>
      </view>
    </view>
  </view>
</view>
