<!-- åº“å­˜ç®¡ç†é¡µ -->
<view class="stock-container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ -->
  <view class="stats-cards">
    <view class="stat-card">
      <text class="stat-value">{{totalProducts}}</text>
      <text class="stat-label">å•†å“æ€»æ•°</text>
    </view>
    <view class="stat-card warning">
      <text class="stat-value">{{lowStockCount}}</text>
      <text class="stat-label">åº“å­˜é¢„è­¦</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{outOfStockCount}}</text>
      <text class="stat-label">å·²å”®ç½„</text>
    </view>
  </view>

  <!-- Tabåˆ‡æ¢ -->
  <view class="tab-section">
    <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">
      å…¨éƒ¨åº“å­˜
    </view>
    <view class="tab-item {{currentTab === 'warning' ? 'active' : ''}}" bindtap="switchTab" data-tab="warning">
      åº“å­˜é¢„è­¦
      <text class="badge" wx:if="{{lowStockCount > 0}}">{{lowStockCount}}</text>
    </view>
    <view class="tab-item {{currentTab === 'record' ? 'active' : ''}}" bindtap="switchTab" data-tab="record">
      åº“å­˜è®°å½•
    </view>
  </view>

  <!-- å…¨éƒ¨åº“å­˜/åº“å­˜é¢„è­¦åˆ—è¡¨ -->
  <view class="stock-list" wx:if="{{currentTab !== 'record'}}">
    <view class="stock-item {{item.stock <= item.warningStock ? 'warning' : ''}}" 
          wx:for="{{stockList}}" 
          wx:key="id">
      <image class="product-image" src="{{item.image}}" mode="aspectFill" wx:if="{{item.image}}"></image>
      <view class="product-image placeholder" wx:else></view>
      
      <view class="stock-info">
        <view class="product-name">{{item.name}}</view>
        <view class="stock-detail">
          <text class="current-stock">å½“å‰åº“å­˜: <text class="stock-num {{item.stock <= item.warningStock ? 'warning-text' : ''}}">{{item.stock}}</text></text>
          <text class="warning-stock">é¢„è­¦å€¼: {{item.warningStock}}</text>
        </view>
        <view class="stock-progress">
          <view class="progress-bar">
            <view class="progress-fill {{item.stock <= item.warningStock ? 'warning' : ''}}" style="width: {{(item.stock / (item.warningStock * 3)) * 100}}%"></view>
          </view>
        </view>
      </view>

      <view class="stock-actions">
        <button class="action-btn in" bindtap="showStockModal" data-type="in" data-id="{{item.id}}" data-name="{{item.name}}" plain>
          <text class="iconfont icon-in"></text>
          <text>å…¥åº“</text>
        </button>
        <button class="action-btn out {{item.stock <= 0 ? 'disabled' : ''}}" bindtap="showStockModal" data-type="out" data-id="{{item.id}}" data-name="{{item.name}}" plain disabled="{{item.stock <= 0}}">
          <text class="iconfont icon-out"></text>
          <text>å‡ºåº“</text>
        </button>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{stockList.length === 0 && !isLoading}}">
      <view class="empty-icon">ğŸ“¦</view>
      <text class="empty-text">{{currentTab === 'warning' ? 'æš‚æ— åº“å­˜é¢„è­¦å•†å“' : 'æš‚æ— åº“å­˜æ•°æ®'}}</text>
    </view>
  </view>

  <!-- åº“å­˜è®°å½• -->
  <view class="record-list" wx:if="{{currentTab === 'record'}}">
    <view class="record-filter">
      <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
        <view class="date-picker">
          {{startDate || 'å¼€å§‹æ—¥æœŸ'}}
          <text class="iconfont icon-down"></text>
        </view>
      </picker>
      <text class="date-separator">è‡³</text>
      <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
        <view class="date-picker">
          {{endDate || 'ç»“æŸæ—¥æœŸ'}}
          <text class="iconfont icon-down"></text>
        </view>
      </picker>
      <view class="filter-btn" bindtap="filterRecords">æŸ¥è¯¢</view>
    </view>

    <view class="record-item {{item.type === 'in' ? 'in' : 'out'}}" wx:for="{{stockRecords}}" wx:key="id">
      <view class="record-icon">
        <text class="iconfont {{item.type === 'in' ? 'icon-in' : 'icon-out'}}"></text>
      </view>
      <view class="record-content">
        <view class="record-header">
          <text class="product-name">{{item.productName}}</text>
          <text class="record-quantity {{item.type}}">{{item.type === 'in' ? '+' : '-'}}{{item.quantity}}</text>
        </view>
        <view class="record-detail">
          <text class="record-type">{{item.typeName}}</text>
          <text class="record-time">{{item.createTime}}</text>
        </view>
        <view class="record-remark" wx:if="{{item.remark}}">å¤‡æ³¨: {{item.remark}}</view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{stockRecords.length === 0 && !isLoading}}">
      <image class="empty-image" src="/images/empty-record.png" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— åº“å­˜è®°å½•</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{(currentTab !== 'record' && stockList.length > 0) || (currentTab === 'record' && stockRecords.length > 0)}}">
    <text wx:if="{{isLoading}}">åŠ è½½ä¸­...</text>
    <text wx:elif="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    <text wx:else>æ²¡æœ‰æ›´å¤šäº†</text>
  </view>
</view>

<!-- åº“å­˜è°ƒæ•´å¼¹çª— -->
<view class="stock-modal-container" hidden="{{!showModal}}" bindtap="hideModal">
  <view class="stock-modal" catchtap="onModalTap">
    <!-- Header -->
    <view class="stock-modal-header">
      <text class="stock-modal-title">{{modalType === 'in' ? 'å•†å“å…¥åº“' : 'å•†å“å‡ºåº“'}}</text>
      <view class="stock-modal-close" bindtap="hideModal">
        <text class="close-icon">Ã—</text>
      </view>
    </view>

    <!-- Product Info -->
    <view class="stock-modal-product">
      <text class="product-label">å•†å“åç§°</text>
      <text class="product-value">{{modalProductName}}</text>
    </view>

    <view class="stock-modal-divider"></view>

    <!-- Form -->
    <view class="stock-modal-body">
      <view class="form-item">
        <text class="form-label">{{modalType === 'in' ? 'å…¥åº“æ•°é‡' : 'å‡ºåº“æ•°é‡'}} <text class="required">*</text></text>
        <input
          class="form-input"
          type="number"
          placeholder="è¯·è¾“å…¥æ•°é‡"
          value="{{modalQuantity}}"
          bindinput="onQuantityInput"
        />
      </view>

      <view class="form-item">
        <text class="form-label">æ“ä½œç±»å‹</text>
        <picker bindchange="onOperationTypeChange" value="{{operationTypeIndex}}" range="{{operationTypes}}" range-key="name">
          <view class="picker-value">
            {{operationTypes[operationTypeIndex].name}}
            <text class="iconfont icon-right"></text>
          </view>
        </picker>
      </view>

      <view class="form-item">
        <text class="form-label">å¤‡æ³¨</text>
        <textarea
          class="form-textarea"
          placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
          value="{{modalRemark}}"
          bindinput="onRemarkInput"
          maxlength="100"
        />
      </view>
    </view>

    <!-- Footer -->
    <view class="stock-modal-footer">
      <button class="cancel-btn" bindtap="hideModal" plain>å–æ¶ˆ</button>
      <button class="confirm-btn {{modalType === 'in' ? 'in' : 'out'}}" bindtap="confirmStockOperation" plain>
        ç¡®è®¤{{modalType === 'in' ? 'å…¥åº“' : 'å‡ºåº“'}}
      </button>
    </view>
  </view>
</view>
