<!-- 积分充值管理页 -->
<view class="points-manage-container">
  <!-- 头部统计 -->
  <view class="header-stats">
    <view class="stat-card">
      <text class="stat-value">{{stats.totalUsers}}</text>
      <text class="stat-label">积分用户</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{stats.totalPoints}}</text>
      <text class="stat-label">积分总量</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{stats.todayCharged}}</text>
      <text class="stat-label">今日充值</text>
    </view>
  </view>

  <!-- 快捷充值入口 -->
  <view class="quick-charge-section" wx:if="{{currentTab === 'charge'}}">
    <view class="section-title">为用户充值积分</view>
    <view class="charge-form">
      <view class="form-item">
        <text class="label">用户搜索</text>
        <view class="search-box">
          <input
            type="text"
            placeholder="输入手机号或昵称搜索用户"
            value="{{searchKeyword}}"
            bindinput="onSearchInput"
            bindconfirm="searchUsers"
          />
          <button class="search-btn" bindtap="searchUsers">搜索</button>
        </view>
      </view>

      <!-- 搜索结果 -->
      <view class="search-results" wx:if="{{searchResults.length > 0}}">
        <view class="result-item {{selectedUser && selectedUser._id === item._id ? 'selected' : ''}}"
              wx:for="{{searchResults}}"
              wx:key="_id"
              bindtap="selectUser"
              data-user="{{item}}">
          <image class="user-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"/>
          <view class="user-info">
            <text class="user-name">{{item.nickName || '未知用户'}}</text>
            <text class="user-phone">{{item.phone || '未绑定手机'}}</text>
          </view>
          <view class="user-points">
            <text class="points-label">当前积分</text>
            <text class="points-value">{{item.points || 0}}</text>
          </view>
        </view>
      </view>

      <view class="no-results" wx:if="{{searched && searchResults.length === 0}}">
        <text>未找到匹配的用户</text>
      </view>

      <!-- 充值表单 -->
      <block wx:if="{{selectedUser}}">
        <view class="selected-user">
          <text class="label">已选用户</text>
          <view class="user-tag">
            <image class="tag-avatar" src="{{selectedUser.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"/>
            <text>{{selectedUser.nickName}}</text>
            <text class="close-icon" bindtap="clearSelectedUser">×</text>
          </view>
        </view>

        <view class="form-item">
          <text class="label">充值积分</text>
          <view class="points-input-group">
            <input
              type="number"
              placeholder="请输入积分数量"
              value="{{chargePoints}}"
              bindinput="onPointsInput"
            />
            <text class="unit">积分</text>
          </view>
        </view>

        <view class="form-item">
          <text class="label">充值原因</text>
          <textarea
            placeholder="请输入充值原因（可选）"
            value="{{chargeReason}}"
            bindinput="onReasonInput"
            maxlength="100"
          />
        </view>

        <view class="quick-amounts">
          <text class="quick-label">快捷金额：</text>
          <view class="amount-tags">
            <text class="amount-tag {{chargePoints === '100' ? 'active' : ''}}" bindtap="selectQuickAmount" data-amount="100">100</text>
            <text class="amount-tag {{chargePoints === '500' ? 'active' : ''}}" bindtap="selectQuickAmount" data-amount="500">500</text>
            <text class="amount-tag {{chargePoints === '1000' ? 'active' : ''}}" bindtap="selectQuickAmount" data-amount="1000">1000</text>
            <text class="amount-tag {{chargePoints === '5000' ? 'active' : ''}}" bindtap="selectQuickAmount" data-amount="5000">5000</text>
          </view>
        </view>

        <button class="charge-btn {{isCharging ? 'loading' : ''}}" bindtap="submitCharge">
          <text wx:if="{{!isCharging}}">确认充值</text>
          <text wx:else>处理中...</text>
        </button>
      </block>
    </view>
  </view>

  <!-- 标签切换 -->
  <view class="tabs-section" wx:if="{{currentTab !== 'charge'}}">
    <view class="tab {{currentTab === 'records' ? 'active' : ''}}" bindtap="switchTab" data-tab="records">
      充值记录
    </view>
    <view class="tab {{currentTab === 'users' ? 'active' : ''}}" bindtap="switchTab" data-tab="users">
      用户积分
    </view>
  </view>

  <!-- 充值记录列表 -->
  <view class="records-section" wx:if="{{currentTab === 'records'}}">
    <view class="filter-bar">
      <picker mode="date" value="{{filterDate}}" bindchange="onDateChange">
        <view class="date-picker">
          <text class="iconfont icon-calendar"></text>
          <text>{{filterDate || '选择日期'}}</text>
          <text class="iconfont icon-down"></text>
        </view>
      </picker>
      <text class="clear-filter" wx:if="{{filterDate}}" bindtap="clearFilter">清除筛选</text>
    </view>

    <view class="record-list">
      <view class="record-item" wx:for="{{records}}" wx:key="_id">
        <view class="record-left">
          <image class="user-avatar" src="{{item.userAvatar || '/images/default-avatar.png'}}" mode="aspectFill"/>
          <view class="record-info">
            <text class="user-name">{{item.userName || '未知用户'}}</text>
            <text class="record-time">{{item.createTime}}</text>
            <text class="record-reason" wx:if="{{item.reason}}">{{item.reason}}</text>
          </view>
        </view>
        <view class="record-right">
          <text class="points-change">+{{item.points}}</text>
          <text class="operator">操作员: {{item.operator || '系统'}}</text>
        </view>
      </view>

      <view class="empty-state" wx:if="{{records.length === 0 && !isLoading}}">
        <image class="empty-image" src="/images/empty-record.png" mode="aspectFit"/>
        <text class="empty-text">暂无充值记录</text>
      </view>
    </view>

    <view class="load-more" wx:if="{{records.length > 0}}">
      <text wx:if="{{isLoading}}">加载中...</text>
      <text wx:elif="{{hasMore}}">上拉加载更多</text>
      <text wx:else>没有更多记录了</text>
    </view>
  </view>

  <!-- 用户积分列表 -->
  <view class="users-section" wx:if="{{currentTab === 'users'}}">
    <view class="search-bar">
      <view class="search-input">
        <text class="iconfont icon-search"></text>
        <input
          type="text"
          placeholder="搜索用户"
          value="{{userSearchKeyword}}"
          bindinput="onUserSearchInput"
          bindconfirm="searchUserPoints"
        />
      </view>
      <view class="sort-btn" bindtap="toggleSort">
        <text>积分</text>
        <text class="iconfont {{sortDesc ? 'icon-down' : 'icon-up'}}"></text>
      </view>
    </view>

    <view class="user-list">
      <view class="user-item" wx:for="{{userPointsList}}" wx:key="_id">
        <view class="rank-num {{index < 3 ? 'top' : ''}}">{{index + 1}}</view>
        <image class="user-avatar" src="{{item.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"/>
        <view class="user-info">
          <text class="user-name">{{item.nickName || '未知用户'}}</text>
          <text class="user-phone">{{item.phone || ''}}</text>
        </view>
        <view class="points-info">
          <text class="points-value">{{item.points || 0}}</text>
          <text class="points-label">积分</text>
        </view>
        <view class="action-btn" bindtap="quickChargeUser" data-user="{{item}}">
          <text class="iconfont icon-plus"></text>
        </view>
      </view>

      <view class="empty-state" wx:if="{{userPointsList.length === 0 && !isLoading}}">
        <text class="empty-text">暂无用户数据</text>
      </view>
    </view>

    <view class="load-more" wx:if="{{userPointsList.length > 0}}">
      <text wx:if="{{isLoading}}">加载中...</text>
      <text wx:elif="{{hasMore}}">上拉加载更多</text>
      <text wx:else>没有更多用户了</text>
    </view>
  </view>

  <!-- 浮动充值按钮 -->
  <view class="fab-charge" bindtap="showChargePanel" wx:if="{{currentTab !== 'charge'}}">
    <text class="iconfont icon-plus"></text>
    <text>充值</text>
  </view>
</view>
