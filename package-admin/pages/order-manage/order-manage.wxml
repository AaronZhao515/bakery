<!-- è®¢å•ç®¡ç†é¡µé¢ -->
<view class="order-manage-container">
  <!-- ç­›é€‰æ  -->
  <view class="filter-section">
    <!-- æ—¥æœŸç­›é€‰ -->
    <view class="date-filter">
      <picker mode="date" value="{{startDate}}" bindchange="onStartDateChange">
        <view class="date-picker {{startDate ? 'active' : ''}}">
          {{startDate || 'å¼€å§‹æ—¥æœŸ'}}
        </view>
      </picker>
      <text class="date-separator">è‡³</text>
      <picker mode="date" value="{{endDate}}" bindchange="onEndDateChange">
        <view class="date-picker {{endDate ? 'active' : ''}}">
          {{endDate || 'ç»“æŸæ—¥æœŸ'}}
        </view>
      </picker>
      <view class="filter-btn" bindtap="applyDateFilter">ç­›é€‰</view>
      <view class="reset-btn" bindtap="resetFilter" wx:if="{{startDate || endDate || status}}">é‡ç½®</view>
    </view>

    <!-- çŠ¶æ€ç­›é€‰ -->
    <scroll-view class="status-filter" scroll-x>
      <view class="status-list">
        <view class="status-item {{status === '' ? 'active' : ''}}" bindtap="filterByStatus" data-status="">
          å…¨éƒ¨
        </view>
        <view class="status-item {{status === '0' ? 'active' : ''}}" bindtap="filterByStatus" data-status="0">
          å¾…æ”¯ä»˜
        </view>
        <view class="status-item {{status === '1' ? 'active' : ''}}" bindtap="filterByStatus" data-status="1">
          å·²æ”¯ä»˜
        </view>
        <view class="status-item {{status === '2' ? 'active' : ''}}" bindtap="filterByStatus" data-status="2">
          åˆ¶ä½œä¸­
        </view>
        <view class="status-item {{status === '3' ? 'active' : ''}}" bindtap="filterByStatus" data-status="3">
          é…é€ä¸­
        </view>
        <view class="status-item {{status === '4' ? 'active' : ''}}" bindtap="filterByStatus" data-status="4">
          å·²å®Œæˆ
        </view>
        <view class="status-item {{status === '-1' ? 'active' : ''}}" bindtap="filterByStatus" data-status="-1">
          å·²å–æ¶ˆ
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar" wx:if="{{orderStats.total > 0}}">
    <text class="stats-text">å…± <text>{{orderStats.total}}</text> å•</text>
    <text class="stats-text" wx:if="{{orderStats.totalAmount > 0}}">åˆè®¡ <text>Â¥{{orderStats.totalAmount}}</text></text>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card" wx:for="{{orderList}}" wx:key="_id" bindtap="viewOrderDetail" data-id="{{item._id}}">
      <!-- è®¢å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-no">{{item.orderNo}}</text>
          <text class="order-time">{{item.createTime}}</text>
        </view>
        <view class="order-tags">
          <view class="delivery-type-tag {{item.deliveryTypeClass}}">{{item.deliveryTypeText}}</view>
          <view class="order-status {{item.statusClass}}">{{item.statusText}}</view>
        </view>
      </view>

      <!-- å•†å“ä¿¡æ¯ -->
      <view class="product-section">
        <view class="product-list">
          <view class="product-item" wx:for="{{item.products}}" wx:key="index" wx:for-item="product">
            <image class="product-image" src="{{product.image || '/images/default-product.png'}}" mode="aspectFill" lazy-load></image>
            <view class="product-detail">
              <text class="product-name">{{product.name}}</text>
              <text class="product-spec" wx:if="{{product.spec}}">{{product.spec}}</text>
              <view class="product-price-row">
                <text class="product-price">Â¥{{product.price}}</text>
                <text class="product-quantity">x{{product.quantity}}</text>
              </view>
            </view>
          </view>
        </view>
        <view class="more-products" wx:if="{{item.productCount > 2}}">
          ç­‰å…± {{item.productCount}} ä»¶å•†å“
        </view>
      </view>

      <!-- è®¢å•é‡‘é¢ -->
      <view class="amount-section">
        <text class="amount-label">å®ä»˜é‡‘é¢</text>
        <text class="amount-value">Â¥{{item.payAmount}}</text>
      </view>

      <!-- ç”¨æˆ·ä¿¡æ¯ -->
      <view class="user-section" wx:if="{{item.userInfo}}">
        <image class="user-avatar" src="{{item.userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill" lazy-load></image>
        <text class="user-name">{{item.userInfo.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
        <text class="user-phone" wx:if="{{item.userInfo.phone}}">{{item.userInfo.phone}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-section">
        <button class="action-btn secondary" size="mini" catchtap="contactCustomer" data-id="{{item._id}}">è”ç³»å®¢æˆ·</button>
        <!-- å·²æ”¯ä»˜çŠ¶æ€ - æ˜¾ç¤ºå¤„ç†è®¢å• -->
        <button class="action-btn primary" size="mini" catchtap="processOrder" data-id="{{item._id}}" data-status="{{item.status}}" wx:if="{{item.status === 1}}">å¤„ç†è®¢å•</button>
        <!-- åˆ¶ä½œä¸­çŠ¶æ€ - æ ¹æ®é…é€ç±»å‹æ˜¾ç¤ºä¸åŒæŒ‰é’® -->
        <button class="action-btn delivery" size="mini" catchtap="goToDelivery" data-id="{{item._id}}" wx:elif="{{item.status === 2 && item.deliveryType === 1}}">å»é…é€</button>
        <button class="action-btn primary" size="mini" catchtap="processOrder" data-id="{{item._id}}" data-status="{{item.status}}" wx:elif="{{item.status === 2}}">å¤„ç†è®¢å•</button>
        <button class="action-btn primary" size="mini" catchtap="viewOrderDetail" data-id="{{item._id}}">æŸ¥çœ‹è¯¦æƒ…</button>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{orderList.length === 0 && !isLoading}}">
      <image class="empty-image" src="/images/empty-order.png" mode="aspectFit"></image>
      <text class="empty-text">æš‚æ— è®¢å•</text>
      <text class="empty-subtext">{{startDate || endDate || status ? 'å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶' : 'è¿˜æ²¡æœ‰æ”¶åˆ°è®¢å•'}}</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{orderList.length > 0}}">
    <text wx:if="{{isLoading}}">åŠ è½½ä¸­...</text>
    <text wx:elif="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    <text wx:else>â€” å·²ç»åˆ°åº•äº† â€”</text>
  </view>
</view>

<!-- å¤„ç†è®¢å•å¼¹çª— -->
<view class="process-modal" wx:if="{{showProcessModal}}">
  <view class="modal-mask" bindtap="hideProcessModal"></view>
  <view class="modal-content" catchtap="onModalContentTap">
    <view class="modal-header">
      <text class="modal-title">å¤„ç†è®¢å•</text>
      <text class="close-btn" catchtap="hideProcessModal">Ã—</text>
    </view>

    <view class="modal-body">
      <!-- è®¢å•è¿›åº¦æ­¥éª¤ -->
      <view class="process-steps">
        <view class="step-item {{currentOrder.status >= 1 ? 'completed' : ''}} {{currentOrder.status === 1 ? 'active' : ''}}">
          <view class="step-icon">
            <text class="iconfont icon-check" wx:if="{{currentOrder.status > 1}}">âœ“</text>
            <text wx:else>1</text>
          </view>
          <text class="step-text">å·²æ”¯ä»˜</text>
        </view>
        <view class="step-line"></view>
        <view class="step-item {{currentOrder.status >= 2 ? 'completed' : ''}} {{currentOrder.status === 2 ? 'active' : ''}}">
          <view class="step-icon">
            <text class="iconfont icon-check" wx:if="{{currentOrder.status > 2}}">âœ“</text>
            <text wx:else>2</text>
          </view>
          <text class="step-text">åˆ¶ä½œä¸­</text>
        </view>
        <view class="step-line"></view>
        <view class="step-item {{currentOrder.status >= 3 ? 'completed' : ''}} {{currentOrder.status === 3 ? 'active' : ''}}">
          <view class="step-icon">
            <text class="iconfont icon-check" wx:if="{{currentOrder.status > 3}}">âœ“</text>
            <text wx:else>3</text>
          </view>
          <text class="step-text">é…é€ä¸­</text>
        </view>
        <view class="step-line"></view>
        <view class="step-item {{currentOrder.status === 4 ? 'completed' : ''}} {{currentOrder.status === 4 ? 'active' : ''}}">
          <view class="step-icon">
            <text wx:if="{{currentOrder.status === 4}}">âœ“</text>
            <text wx:else>4</text>
          </view>
          <text class="step-text">å·²å®Œæˆ</text>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
      <view class="process-actions">
        <view class="action-title">é€‰æ‹©æ“ä½œ</view>
        <view class="action-grid">
          <view class="process-action {{currentOrder.status === 1 ? 'enabled' : 'disabled'}}" bindtap="updateOrderStatus" data-status="2">
            <text class="action-icon">ğŸ³</text>
            <text class="action-name">å¼€å§‹åˆ¶ä½œ</text>
          </view>
          <view class="process-action {{currentOrder.status === 2 ? 'enabled' : 'disabled'}}" bindtap="updateOrderStatus" data-status="3">
            <text class="action-icon">ğŸšš</text>
            <text class="action-name">å¼€å§‹é…é€</text>
          </view>
          <view class="process-action {{currentOrder.status === 3 ? 'enabled' : 'disabled'}}" bindtap="updateOrderStatus" data-status="4">
            <text class="action-icon">âœ…</text>
            <text class="action-name">å®Œæˆè®¢å•</text>
          </view>
          <view class="process-action enabled" bindtap="cancelOrder" wx:if="{{currentOrder.status <= 1}}">
            <text class="action-icon">âŒ</text>
            <text class="action-name">å–æ¶ˆè®¢å•</text>
          </view>
        </view>
      </view>

      <!-- å¤‡æ³¨åŒºåŸŸ -->
      <view class="remark-section">
        <text class="section-label">å¤‡æ³¨ï¼ˆé€‰å¡«ï¼‰</text>
        <input
          class="remark-input"
          placeholder="æ·»åŠ è®¢å•å¤„ç†å¤‡æ³¨..."
          value="{{processRemark}}"
          bindinput="onRemarkInput"
          maxlength="200"
          placeholder-class="placeholder-style"
        />
      </view>
    </view>

    <view class="modal-footer">
      <button class="btn-secondary" bindtap="hideProcessModal">å…³é—­</button>
    </view>
  </view>
</view>
