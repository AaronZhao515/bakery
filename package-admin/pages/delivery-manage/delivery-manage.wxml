<!-- é…é€ç®¡ç†é¡µ -->
<view class="delivery-manage-container">
  <!-- é¡¶éƒ¨ç»Ÿè®¡ -->
  <view class="header-stats">
    <view class="stat-card">
      <text class="stat-value">{{stats.pendingPack}}</text>
      <text class="stat-label">å¾…æ‰“åŒ…</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{stats.pendingDelivery}}</text>
      <text class="stat-label">å¾…é…é€</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{stats.delivering}}</text>
      <text class="stat-label">é…é€ä¸­</text>
    </view>
    <view class="stat-card">
      <text class="stat-value">{{stats.completedToday}}</text>
      <text class="stat-label">ä»Šæ—¥å®Œæˆ</text>
    </view>
  </view>

  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tabs-section">
    <view class="tab {{currentTab === 'pending' ? 'active' : ''}}" bindtap="switchTab" data-tab="pending">
      å¾…å¤„ç†
      <text class="badge" wx:if="{{stats.pendingPack + stats.pendingDelivery > 0}}">{{stats.pendingPack + stats.pendingDelivery}}</text>
    </view>
    <view class="tab {{currentTab === 'delivering' ? 'active' : ''}}" bindtap="switchTab" data-tab="delivering">
      é…é€ä¸­
    </view>
    <view class="tab {{currentTab === 'completed' ? 'active' : ''}}" bindtap="switchTab" data-tab="completed">
      å·²å®Œæˆ
    </view>
  </view>

  <!-- è®¢å•åˆ—è¡¨ -->
  <view class="order-list">
    <view class="order-card {{item.status}} {{item.highlighted ? 'highlighted' : ''}} order-item" wx:for="{{orders}}" wx:key="_id" data-id="{{item._id}}" bindtap="showOrderDetail">
      <!-- è®¢å•å¤´éƒ¨ -->
      <view class="order-header">
        <view class="order-info">
          <text class="order-no">{{item.orderNo}}</text>
          <text class="order-time">{{item.createTime}}</text>
        </view>
        <view class="status-tag {{item.statusClass}}">{{item.statusText}}</view>
      </view>

      <!-- å•†å“åˆ—è¡¨ -->
      <view class="product-list">
        <view class="product-item" wx:for="{{item.products}}" wx:key="id" wx:for-item="product">
          <image class="product-image" src="{{product.image || '/images/default-product.png'}}" mode="aspectFill"/>
          <view class="product-detail">
            <text class="product-name">{{product.name}}</text>
            <text class="product-spec" wx:if="{{product.spec}}">{{product.spec}}</text>
            <view class="product-price-row">
              <text class="product-price">Â¥{{product.price}}</text>
              <text class="product-quantity">x{{product.quantity}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- é…é€ä¿¡æ¯ -->
      <view class="delivery-info">
        <view class="info-row">
          <text class="iconfont icon-user"></text>
          <text class="info-text">{{item.userName}} {{item.userPhone}}</text>
        </view>
        <view class="info-row" wx:if="{{item.deliveryType === 'delivery'}}">
          <text class="iconfont icon-location"></text>
          <text class="info-text">{{item.address}}</text>
        </view>
        <view class="info-row" wx:if="{{item.deliveryType === 'pickup'}}">
          <text class="iconfont icon-store"></text>
          <text class="info-text">åˆ°åº—è‡ªæ - {{item.pickupTime}}</text>
        </view>
        <view class="info-row" wx:if="{{item.remark}}">
          <text class="iconfont icon-note"></text>
          <text class="info-text remark">å¤‡æ³¨: {{item.remark}}</text>
        </view>
      </view>

      <!-- è®¢å•é‡‘é¢ -->
      <view class="order-amount">
        <text class="amount-label">è®¢å•é‡‘é¢</text>
        <text class="amount-value">Â¥{{item.payAmount}}</text>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="action-buttons">
        <!-- å¾…æ‰“åŒ…çŠ¶æ€ -->
        <block wx:if="{{item.status === 1}}">
          <button class="btn-secondary" bindtap="printOrder" data-id="{{item._id}}">
            <text class="iconfont icon-print"></text>
            æ‰“å°
          </button>
          <button class="btn-primary" bindtap="startPack" data-id="{{item._id}}">
            å¼€å§‹æ‰“åŒ…
          </button>
        </block>

        <!-- æ‰“åŒ…ä¸­çŠ¶æ€ -->
        <block wx:if="{{item.status === 2}}">
          <button class="btn-secondary" bindtap="printOrder" data-id="{{item._id}}">
            è¡¥æ‰“æ ‡ç­¾
          </button>
          <button class="btn-primary" bindtap="finishPack" data-id="{{item._id}}">
            å®Œæˆæ‰“åŒ…
          </button>
        </block>

        <!-- å¾…é…é€çŠ¶æ€ -->
        <block wx:if="{{item.status === 3}}">
          <button class="btn-secondary" bindtap="contactUser" data-phone="{{item.userPhone}}">
            è”ç³»é¡¾å®¢
          </button>
          <button class="btn-primary" bindtap="startDelivery" data-id="{{item._id}}">
            å¼€å§‹é…é€
          </button>
        </block>

        <!-- é…é€ä¸­çŠ¶æ€ -->
        <block wx:if="{{item.status === 4}}">
          <button class="btn-secondary" bindtap="contactUser" data-phone="{{item.userPhone}}">
            è”ç³»é¡¾å®¢
          </button>
          <button class="btn-primary" bindtap="completeDelivery" data-id="{{item._id}}">
            å®Œæˆé…é€
          </button>
        </block>

        <!-- å·²å®ŒæˆçŠ¶æ€ -->
        <block wx:if="{{item.status === 5}}">
          <button class="btn-secondary" bindtap="viewDetail" data-id="{{item._id}}">
            æŸ¥çœ‹è¯¦æƒ…
          </button>
          <text class="complete-time">å®Œæˆäº {{item.completeTime}}</text>
        </block>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{orders.length === 0 && !isLoading}}">
      <text class="empty-icon">ğŸ“¦</text>
      <text class="empty-text">æš‚æ— {{currentTab === 'pending' ? 'å¾…å¤„ç†' : currentTab === 'delivering' ? 'é…é€ä¸­' : 'å·²å®Œæˆ'}}è®¢å•</text>
      <text class="empty-subtext">é…é€è®¢å•å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</text>
    </view>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{orders.length > 0}}">
    <text wx:if="{{isLoading}}">åŠ è½½ä¸­...</text>
    <text wx:elif="{{hasMore}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    <text wx:else>æ²¡æœ‰æ›´å¤šè®¢å•äº†</text>
  </view>

  <!-- é…é€å‘˜é€‰æ‹©å¼¹çª—ï¼ˆå·²ç¦ç”¨ï¼‰ -->

  <!-- è®¢å•è¯¦æƒ…å¼¹çª— -->
  <view class="detail-modal {{showOrderDetailModal ? 'show' : ''}}" wx:if="{{showOrderDetailModal}}">
    <view class="detail-modal-mask" bindtap="hideOrderDetail"></view>
    <view class="detail-modal-content">
      <view class="detail-modal-header">
        <text class="detail-modal-title">è®¢å•è¯¦æƒ…</text>
        <text class="detail-modal-close" bindtap="hideOrderDetail">Ã—</text>
      </view>

      <scroll-view class="detail-modal-body" scroll-y>
        <block wx:if="{{currentOrder}}">
          <!-- è®¢å•çŠ¶æ€ -->
          <view class="detail-section">
            <view class="detail-status-row">
              <text class="detail-status-tag {{currentOrder.statusClass}}">{{currentOrder.statusText}}</text>
              <text class="detail-order-no">è®¢å•å·ï¼š{{currentOrder.orderNo}}</text>
            </view>
            <text class="detail-order-time">ä¸‹å•æ—¶é—´ï¼š{{currentOrder.createTime}}</text>
          </view>

          <!-- å•†å“ä¿¡æ¯ -->
          <view class="detail-section">
            <view class="detail-section-title">å•†å“ä¿¡æ¯</view>
            <view class="detail-product-list">
              <view class="detail-product-item" wx:for="{{currentOrder.products}}" wx:key="id" wx:for-item="product">
                <image class="detail-product-image" src="{{product.image || '/images/default-product.png'}}" mode="aspectFill"/>
                <view class="detail-product-info">
                  <text class="detail-product-name">{{product.name}}</text>
                  <text class="detail-product-spec" wx:if="{{product.spec}}">{{product.spec}}</text>
                  <view class="detail-product-meta">
                    <text class="detail-product-price">Â¥{{product.price}}</text>
                    <text class="detail-product-quantity">Ã—{{product.quantity}}</text>
                  </view>
                </view>
                <text class="detail-product-total">Â¥{{product.totalAmount}}</text>
              </view>
            </view>
          </view>

          <!-- é…é€ä¿¡æ¯ -->
          <view class="detail-section">
            <view class="detail-section-title">é…é€ä¿¡æ¯</view>
            <view class="detail-info-list">
              <view class="detail-info-item">
                <text class="detail-info-label">æ”¶è´§äºº</text>
                <text class="detail-info-value">{{currentOrder.userName || 'æœªçŸ¥ç”¨æˆ·'}} {{currentOrder.userPhone}}</text>
              </view>
              <view class="detail-info-item">
                <text class="detail-info-label">é…é€åœ°å€</text>
                <text class="detail-info-value">{{currentOrder.address || 'æš‚æ— åœ°å€ä¿¡æ¯'}}</text>
              </view>
              <view class="detail-info-item" wx:if="{{currentOrder.remark}}">
                <text class="detail-info-label">è®¢å•å¤‡æ³¨</text>
                <text class="detail-info-value remark">{{currentOrder.remark}}</text>
              </view>
            </view>
          </view>

          <!-- é‡‘é¢ä¿¡æ¯ -->
          <view class="detail-section">
            <view class="detail-section-title">é‡‘é¢æ˜ç»†</view>
            <view class="detail-amount-list">
              <view class="detail-amount-item">
                <text class="detail-amount-label">å•†å“æ€»é¢</text>
                <text class="detail-amount-value">Â¥{{currentOrder.totalAmount}}</text>
              </view>
              <view class="detail-amount-item" wx:if="{{currentOrder.deliveryFee > 0}}">
                <text class="detail-amount-label">é…é€è´¹</text>
                <text class="detail-amount-value">+Â¥{{currentOrder.deliveryFee}}</text>
              </view>
              <view class="detail-amount-item" wx:if="{{currentOrder.discountAmount > 0}}">
                <text class="detail-amount-label">ä¼˜æƒ é‡‘é¢</text>
                <text class="detail-amount-value discount">-Â¥{{currentOrder.discountAmount}}</text>
              </view>
              <view class="detail-amount-divider"></view>
              <view class="detail-amount-item total">
                <text class="detail-amount-label">å®ä»˜é‡‘é¢</text>
                <text class="detail-amount-value total">Â¥{{currentOrder.payAmount}}</text>
              </view>
            </view>
          </view>
        </block>
      </scroll-view>

      <view class="detail-modal-footer">
        <button class="detail-btn-close" bindtap="hideOrderDetail">å…³é—­</button>
      </view>
    </view>
  </view>
</view>
